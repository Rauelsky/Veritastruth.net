<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERITAS - Live Assessment</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 8px;
            background: linear-gradient(135deg, #4a9eff 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header .motto {
            color: #4a9eff;
            font-style: italic;
            font-size: 18px;
        }
        
        .header .version {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .mode-btn {
            padding: 12px 30px;
            border: 2px solid #4a9eff;
            background: transparent;
            color: #4a9eff;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #4a9eff 0%, #0f3460 100%);
            color: white;
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Input Section */
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(74, 158, 255, 0.2);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a9eff;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(74, 158, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        .input-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: #666;
        }
        
        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4a9eff 0%, #0f3460 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 158, 255, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 158, 255, 0.3);
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Results */
        .results {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(74, 158, 255, 0.2);
        }
        
        .score-header {
            text-align: center;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .score-number {
            font-size: 72px;
            font-weight: 800;
        }
        
        .score-label {
            font-size: 18px;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .question-display {
            font-size: 20px;
            margin-top: 15px;
            font-style: italic;
        }
        
        /* Scale Visual */
        .scale-visual {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .scale-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .scale-bar {
            height: 30px;
            background: linear-gradient(90deg, 
                #d32f2f 0%, #f44336 20%, #ff9800 40%, 
                #ffc107 50%, #8bc34a 60%, #4caf50 80%, #2e7d32 100%);
            border-radius: 15px;
            position: relative;
        }
        
        .scale-marker {
            position: absolute;
            top: -5px;
            width: 6px;
            height: 40px;
            background: white;
            border: 2px solid #1a1a2e;
            border-radius: 3px;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }
        
        /* Assessment Sections */
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 4px solid #4a9eff;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #4a9eff;
            margin-bottom: 12px;
        }
        
        .section-content {
            color: #ccc;
        }
        
        .section-content p {
            margin-bottom: 10px;
        }
        
        .highlight-section {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .highlight-section .section-title {
            color: #ffc107;
        }
        
        /* Integrity Score */
        .integrity-box {
            background: linear-gradient(135deg, rgba(0, 150, 136, 0.2) 0%, rgba(0, 77, 64, 0.2) 100%);
            border: 2px solid #00796b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .integrity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .integrity-title {
            font-weight: 700;
            color: #4dd0e1;
        }
        
        .integrity-score {
            font-size: 24px;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* API Key Section */
        .api-key-section {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .api-key-section h3 {
            color: #ff9800;
            margin-bottom: 10px;
        }
        
        .api-key-section p {
            color: #999;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .api-key-input {
            display: flex;
            gap: 10px;
        }
        
        .api-key-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 152, 0, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-family: monospace;
        }
        
        .api-key-input button {
            padding: 12px 20px;
            background: #ff9800;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Rate Limit Notice */
        .rate-limit-notice {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rate-limit-notice .remaining {
            font-size: 24px;
            font-weight: 700;
            color: #4a9eff;
        }
        
        /* Error */
        .error-box {
            background: rgba(211, 47, 47, 0.2);
            border: 1px solid #d32f2f;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-box h3 {
            color: #f44336;
            margin-bottom: 10px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
            font-size: 14px;
        }
        
        .footer a {
            color: #4a9eff;
            text-decoration: none;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 32px;
                letter-spacing: 4px;
            }
            
            .mode-toggle {
                flex-direction: column;
            }
            
            .score-number {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>VERITAS</h1>
            <p class="motto">Truth through Transparency</p>
            <p class="version">Live Assessment ‚Ä¢ Web Edition</p>
        </header>
        
        <div class="rate-limit-notice" id="rateLimitNotice">
            Free assessments remaining today: <span class="remaining" id="remainingCount">5</span>
        </div>
        
        <div class="mode-toggle">
            <button class="mode-btn active" id="questionModeBtn" onclick="setMode('question')">
                Ask a Question
            </button>
            <button class="mode-btn" id="articleModeBtn" onclick="setMode('article')">
                Assess an Article
            </button>
        </div>
        
        <div class="input-section">
            <div class="input-group" id="questionGroup">
                <label for="question">Your Question or Claim</label>
                <input type="text" id="question" 
                       placeholder="e.g., 'Is it true that vaccines cause autism?' or 'Did the 2020 election have widespread fraud?'">
            </div>
            
            <div class="input-group" id="articleGroup" style="display: none;">
                <label for="articleText">Article Text</label>
                <textarea id="articleText" 
                          placeholder="Paste the full article text here for assessment..."></textarea>
            </div>
            
            <div class="input-group" id="articleQuestionGroup" style="display: none;">
                <label for="articleQuestion">Specific Question (optional)</label>
                <input type="text" id="articleQuestion" 
                       placeholder="e.g., 'Is this article's main claim accurate?'">
            </div>
            
            <button class="submit-btn" id="submitBtn" onclick="submitAssessment()">
                <span>üîç</span>
                <span>Assess with VERITAS</span>
            </button>
        </div>
        
        <div class="api-key-section" id="apiKeySection" style="display: none;">
            <h3>üîë Use Your Own API Key</h3>
            <p>You've used your free assessments for today. Enter your Anthropic API key to continue, or wait until tomorrow for more free assessments.</p>
            <div class="api-key-input">
                <input type="password" id="userApiKey" placeholder="sk-ant-...">
                <button onclick="saveApiKey()">Save Key</button>
            </div>
        </div>
        
        <div class="error-box" id="errorBox">
            <h3>‚ö†Ô∏è Error</h3>
            <p id="errorMessage"></p>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Investigating your claim...</p>
            <p style="color: #666; font-size: 14px;">This typically takes 30-60 seconds</p>
        </div>
        
        <div class="results" id="results"></div>
        
        <footer class="footer">
            <p>VERITAS ‚Ä¢ Truth through Transparency</p>
            <p><a href="/">‚Üê Back to Home</a> ‚Ä¢ <a href="/demo.html">Interactive Demo</a></p>
            <p style="margin-top: 10px;">¬© 2025 VERITAS LLC</p>
        </footer>
    </div>
    
    <script>
        let currentMode = 'question';
        let userApiKey = localStorage.getItem('veritas_api_key') || '';
        
        // Check if user has their own key
        if (userApiKey) {
            document.getElementById('rateLimitNotice').innerHTML = 
                'üîë Using your API key ‚Ä¢ <a href="#" onclick="clearApiKey()">Use free tier instead</a>';
        }
        
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('questionModeBtn').classList.toggle('active', mode === 'question');
            document.getElementById('articleModeBtn').classList.toggle('active', mode === 'article');
            
            document.getElementById('questionGroup').style.display = mode === 'question' ? 'block' : 'none';
            document.getElementById('articleGroup').style.display = mode === 'article' ? 'block' : 'none';
            document.getElementById('articleQuestionGroup').style.display = mode === 'article' ? 'block' : 'none';
        }
        
        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (key && key.startsWith('sk-ant-')) {
                userApiKey = key;
                localStorage.setItem('veritas_api_key', key);
                document.getElementById('apiKeySection').style.display = 'none';
                document.getElementById('rateLimitNotice').innerHTML = 
                    'üîë Using your API key ‚Ä¢ <a href="#" onclick="clearApiKey()">Use free tier instead</a>';
                alert('API key saved! You can now make unlimited assessments.');
            } else {
                alert('Please enter a valid Anthropic API key (starts with sk-ant-)');
            }
        }
        
        function clearApiKey() {
            userApiKey = '';
            localStorage.removeItem('veritas_api_key');
            document.getElementById('rateLimitNotice').innerHTML = 
                'Free assessments remaining today: <span class="remaining" id="remainingCount">?</span>';
            location.reload();
            return false;
        }
        
        async function submitAssessment() {
            const question = currentMode === 'question' 
                ? document.getElementById('question').value.trim()
                : document.getElementById('articleQuestion').value.trim() || 'Is this article accurate and honest?';
            
            const articleText = currentMode === 'article'
                ? document.getElementById('articleText').value.trim()
                : '';
            
            if (currentMode === 'question' && !question) {
                alert('Please enter a question or claim to assess.');
                return;
            }
            
            if (currentMode === 'article' && !articleText) {
                alert('Please paste the article text to assess.');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            
            try {
                const response = await fetch('/api/assess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question,
                        articleText,
                        userApiKey: userApiKey || undefined
                    })
                });
                
                const data = await response.json();
                
                // Update remaining count from header
                const remaining = response.headers.get('X-Rate-Limit-Remaining');
                if (remaining !== null) {
                    const countEl = document.getElementById('remainingCount');
                    if (countEl) countEl.textContent = remaining;
                }
                
                if (!response.ok) {
                    if (response.status === 429) {
                        // Rate limited
                        document.getElementById('apiKeySection').style.display = 'block';
                        throw new Error(data.message || 'Daily limit reached');
                    }
                    throw new Error(data.message || data.error || 'Assessment failed');
                }
                
                displayResults(data);
                
            } catch (error) {
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        }
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const realityScore = data.realityScore || 0;
            const integrityScore = data.integrityScore || 0;
            
            // Determine color based on score
            let color;
            if (realityScore >= 7) color = '#2e7d32';
            else if (realityScore >= 4) color = '#4caf50';
            else if (realityScore >= 1) color = '#8bc34a';
            else if (realityScore >= -1) color = '#ffc107';
            else if (realityScore >= -4) color = '#ff9800';
            else if (realityScore >= -7) color = '#f44336';
            else color = '#d32f2f';
            
            const position = ((realityScore + 10) / 20) * 100;
            
            let html = `
                <div class="score-header" style="background: linear-gradient(135deg, ${color} 0%, #1a1a2e 100%);">
                    <div class="score-number">${realityScore >= 0 ? '+' : ''}${realityScore}</div>
                    <div class="score-label">Reality Score</div>
                    <div class="question-display">${escapeHtml(data.question)}</div>
                </div>
                
                <div class="scale-visual">
                    <div class="scale-title">Reality Score: ${realityScore >= 0 ? '+' : ''}${realityScore}</div>
                    <div class="scale-bar">
                        <div class="scale-marker" style="left: ${Math.max(0, Math.min(100, position))}%;"></div>
                    </div>
                    <div class="scale-labels">
                        <span>-10<br>FALSE</span>
                        <span>-5</span>
                        <span>0<br>UNCERTAIN</span>
                        <span>+5</span>
                        <span>+10<br>TRUE</span>
                    </div>
                </div>
                
                <div class="integrity-box">
                    <div class="integrity-header">
                        <span class="integrity-title">Epistemological Integrity Score</span>
                        <span class="integrity-score" style="color: ${getIntegrityColor(integrityScore)}">
                            ${integrityScore.toFixed(1)}
                        </span>
                    </div>
                    <p style="color: #999; font-size: 14px;">
                        ${getIntegrityLabel(integrityScore)}
                    </p>
                </div>
            `;
            
            // Parse and display sections
            const sections = parseAssessment(data.assessment);
            for (const section of sections) {
                const isHighlight = section.title.toLowerCase().includes('underlying') || 
                                   section.title.toLowerCase().includes('bottom line') ||
                                   section.title.toLowerCase().includes('veritas assessment');
                html += `
                    <div class="section ${isHighlight ? 'highlight-section' : ''}">
                        <div class="section-title">${escapeHtml(section.title)}</div>
                        <div class="section-content">${formatContent(section.content)}</div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function parseAssessment(text) {
            const sections = [];
            const lines = text.split('\n');
            let currentSection = null;
            
            for (const line of lines) {
                // Check for section headers (bold or **text**)
                const headerMatch = line.match(/^\*\*(.+?)\*\*\s*$/) || 
                                   line.match(/^##\s*(.+)$/) ||
                                   line.match(/^([A-Z][A-Z\s]+):?\s*$/);
                
                if (headerMatch) {
                    if (currentSection) {
                        sections.push(currentSection);
                    }
                    currentSection = {
                        title: headerMatch[1].replace(/\*\*/g, '').trim(),
                        content: ''
                    };
                } else if (currentSection) {
                    currentSection.content += line + '\n';
                }
            }
            
            if (currentSection) {
                sections.push(currentSection);
            }
            
            return sections.filter(s => s.content.trim());
        }
        
        function formatContent(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/<p><br><\/p>/g, '');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getIntegrityColor(score) {
            if (score >= -0.1) return '#4caf50';
            if (score >= -0.3) return '#8bc34a';
            if (score >= -0.5) return '#ffc107';
            if (score >= -0.7) return '#ff9800';
            return '#f44336';
        }
        
        function getIntegrityLabel(score) {
            if (score >= -0.1) return 'Exemplary intellectual honesty';
            if (score >= -0.3) return 'Minor bias or omissions detected';
            if (score >= -0.5) return 'Significant framing issues';
            if (score >= -0.7) return 'Substantial manipulation present';
            return 'Severe deceptive practices detected';
        }
    </script>
</body>
</html>
