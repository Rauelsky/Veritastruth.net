<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERITAS Assessment Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #2B7CD3;
            --navy: #1a365d;
            --navy-dark: #0f172a;
            --amplify-purple: #7c3aed;
            --amplify-purple-dark: #5b21b6;
            --score-green: #22c55e;
            --score-yellow: #eab308;
            --score-red: #ef4444;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --bg-light: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        .site-header {
            background: white;
            border-bottom: 1px solid var(--border-light);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-section img {
            height: 40px;
            width: auto;
        }

        .tagline {
            color: var(--primary-blue);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .version-badge {
            background: var(--bg-light);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            margin-bottom: 24px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-light);
            background: var(--bg-light);
        }

        .mode-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            font-family: inherit;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .mode-tab:hover:not(.active) {
            background: var(--border-light);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Character Counter Styles */
        .input-wrapper {
            position: relative;
        }

        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            margin-top: 6px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .char-counter.green { color: #22c55e; }
        .char-counter.yellow { color: #eab308; }
        .char-counter.red { color: #ef4444; }

        .char-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            display: none;
        }

        .char-warning.visible {
            display: block;
        }

        .input-tip {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        #question {
            min-height: 60px;
            resize: vertical;
        }

        .mode-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .url-field {
            display: none;
            margin-bottom: 16px;
        }

        .url-field.visible {
            display: block;
        }

        .url-field small {
            display: block;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(43, 124, 211, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: var(--bg-light);
            color: var(--text-muted);
            border: 2px solid var(--border-light);
            padding: 14px 20px;
        }

        .btn-clear:hover {
            background: var(--border-light);
            color: var(--text-dark);
        }

        .btn-amplify {
            background: linear-gradient(135deg, var(--amplify-purple) 0%, var(--amplify-purple-dark) 100%);
            color: white;
            width: 100%;
            margin-top: 24px;
            padding: 16px 28px;
        }

        .btn-amplify:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.35);
        }

        /* API Key Section */
        .api-key-section {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .api-key-section summary {
            cursor: pointer;
            font-weight: 600;
            color: #92400e;
            font-size: 0.95rem;
        }

        .api-key-section p {
            margin: 12px 0;
            font-size: 0.9rem;
            color: #78350f;
        }

        .api-key-section input {
            margin-top: 8px;
        }

        .free-tier-note {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 12px;
        }

        /* Error Box */
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            font-size: 0.95rem;
        }

        .error.visible {
            display: block;
        }

        /* Results Section */
        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        /* Hero Score Display */
        .hero-section {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 12px;
            padding: 40px 32px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top, rgba(43, 124, 211, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }

        .hero-score {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .hero-score.positive { color: var(--score-green); }
        .hero-score.negative { color: var(--score-red); }
        .hero-score.neutral { color: var(--score-yellow); }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hero-badge img {
            height: 24px;
            width: auto;
        }

        .hero-badge span {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .hero-question {
            color: white;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 8px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }

        /* Score Bars */
        .score-bars-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .score-bar-wrapper {
            margin-bottom: 28px;
        }

        .score-bar-wrapper:last-child {
            margin-bottom: 0;
        }

        .score-bar-header {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
        }

        .score-bar-title {
            font-weight: 600;
            color: var(--navy);
            font-size: 1rem;
        }

        .score-bar-value {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .score-bar-container {
            position: relative;
            height: 10px;
            border-radius: 5px;
            overflow: visible;
        }

        .score-bar-gradient {
            height: 100%;
            border-radius: 5px;
        }

        .score-bar-gradient.reality {
            background: linear-gradient(90deg, 
                #ef4444 0%, 
                #f97316 20%, 
                #eab308 40%, 
                #84cc16 60%, 
                #22c55e 80%, 
                #16a34a 100%
            );
        }

        .score-bar-gradient.integrity {
            /* Dark Teal (Deceptive) ‚Üí Light Blue (Honest) */
            background: linear-gradient(90deg, 
                #0a1f1c 0%,      /* Nearly black teal - Deceptive */
                #003d33 15%,     /* Dark teal */
                #00574a 30%,     /* Deep teal */
                #00796b 45%,     /* Medium teal */
                #26a69a 60%,     /* Teal */
                #4dd0e1 75%,     /* Cyan */
                #81d4fa 90%,     /* Light blue */
                #b3e5fc 100%     /* Lightest blue - Honest */
            );
        }

        .score-bar-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 18px;
            background: var(--navy-dark);
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .score-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .score-bar-labels span {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Assessment Sections */
        .assessment-section {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 20px 24px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary-blue);
        }

        .assessment-section h3 {
            color: var(--navy);
            font-size: 1.05rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .assessment-section p, .assessment-section ul, .assessment-section li {
            color: var(--text-dark);
            line-height: 1.75;
            font-size: 0.95rem;
        }

        .assessment-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .assessment-section li {
            margin-bottom: 6px;
        }

        /* Section color variants */
        .section-truth { border-left-color: #10b981; }
        .section-truth h3 { color: #065f46; }
        
        .section-assessment { border-left-color: var(--primary-blue); }
        .section-assessment h3 { color: #1e40af; }
        
        .section-claim { border-left-color: #8b5cf6; }
        .section-claim h3 { color: #5b21b6; }
        
        .section-evidence { border-left-color: #f59e0b; }
        .section-evidence h3 { color: #b45309; }
        
        .section-distortion { border-left-color: #ef4444; }
        .section-distortion h3 { color: #b91c1c; }
        
        .section-confident { border-left-color: #10b981; }
        .section-confident h3 { color: #065f46; }
        
        .section-uncertain { border-left-color: #6b7280; }
        .section-uncertain h3 { color: #374151; }
        
        .section-bottom { 
            border-left-color: var(--navy); 
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        }
        .section-bottom h3 { color: var(--navy); }
        
        .section-lessons { border-left-color: #8b5cf6; }
        .section-lessons h3 { color: #5b21b6; }
        
        .section-sources { 
            border-left-color: #64748b; 
            background: #f1f5f9;
        }
        .section-sources h3 { color: #475569; }

        .section-framework { border-left-color: #0891b2; }
        .section-framework h3 { color: #0e7490; }

        .section-integrity { border-left-color: #7c3aed; }
        .section-integrity h3 { color: #5b21b6; }

        .section-methodology { border-left-color: #64748b; }
        .section-methodology h3 { color: #475569; }

        /* Amplified Results */
        .amplified-results {
            display: none;
            margin-top: 24px;
            border: 2px solid var(--amplify-purple);
            border-radius: 12px;
            padding: 24px;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .amplified-results.visible {
            display: block;
        }

        .amplified-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
        }

        .amplified-header h3 {
            color: var(--amplify-purple-dark);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .amplified-section {
            background: white;
            border-radius: 10px;
            padding: 18px 22px;
            margin-bottom: 14px;
            border-left: 4px solid var(--amplify-purple);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .amplified-section:last-child {
            margin-bottom: 0;
        }

        .amplified-section h4 {
            color: var(--amplify-purple-dark);
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .amplified-section p, .amplified-section ul, .amplified-section li {
            color: var(--text-dark);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .amplified-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .amplified-section li {
            margin-bottom: 6px;
        }

        /* Print Styles - Preserve colors and control page breaks */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .site-header {
                position: relative !important;
                border-bottom: 2px solid var(--border-light) !important;
                margin-bottom: 20px !important;
            }

            .container {
                max-width: 100% !important;
                padding: 0 20px !important;
            }

            /* Hide input form when printing results */
            .card:has(#assessBtn) {
                display: none !important;
            }

            /* Keep hero section together */
            .hero-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%) !important;
                margin-bottom: 20px !important;
            }

            .hero-score {
                color: var(--score-green) !important;
            }

            .hero-score.positive { color: #22c55e !important; }
            .hero-score.negative { color: #ef4444 !important; }
            .hero-score.neutral { color: #eab308 !important; }

            /* Keep score bars together */
            .score-bars-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid var(--border-light) !important;
            }

            .score-bar-gradient.reality {
                background: linear-gradient(90deg, 
                    #ef4444 0%, 
                    #f97316 20%, 
                    #eab308 40%, 
                    #84cc16 60%, 
                    #22c55e 80%, 
                    #16a34a 100%
                ) !important;
            }

            .score-bar-gradient.integrity {
                background: linear-gradient(90deg, 
                    #0a1f1c 0%,
                    #003d33 15%,
                    #00574a 30%, 
                    #00796b 45%,
                    #26a69a 60%, 
                    #4dd0e1 75%,
                    #81d4fa 90%,
                    #b3e5fc 100%
                ) !important;
            }

            /* Keep each assessment section together */
            .assessment-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid var(--border-light) !important;
                margin-bottom: 12px !important;
            }

            /* Preserve section border colors */
            .section-truth { border-left: 4px solid #10b981 !important; }
            .section-assessment { border-left: 4px solid #2B7CD3 !important; }
            .section-claim { border-left: 4px solid #8b5cf6 !important; }
            .section-evidence { border-left: 4px solid #f59e0b !important; }
            .section-distortion { border-left: 4px solid #ef4444 !important; }
            .section-confident { border-left: 4px solid #10b981 !important; }
            .section-uncertain { border-left: 4px solid #6b7280 !important; }
            .section-bottom { 
                border-left: 4px solid var(--navy) !important; 
                background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%) !important;
            }
            .section-lessons { border-left: 4px solid #8b5cf6 !important; }
            .section-methodology { border-left: 4px solid #64748b !important; }
            .section-sources { border-left: 4px solid #64748b !important; }
            .section-framework { border-left: 4px solid #0891b2 !important; }
            .section-integrity { border-left: 4px solid #7c3aed !important; }

            /* Hide amplify button in print */
            .btn-amplify {
                display: none !important;
            }

            /* Keep amplified sections together */
            .amplified-results {
                break-before: page !important;
                page-break-before: always !important;
                border: 2px solid var(--amplify-purple) !important;
                background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%) !important;
            }

            .amplified-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                border-left: 4px solid var(--amplify-purple) !important;
                box-shadow: none !important;
                margin-bottom: 10px !important;
            }

            /* Ensure text is black for readability */
            .assessment-section p,
            .assessment-section li,
            .amplified-section p,
            .amplified-section li {
                color: #1e293b !important;
            }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .hero-score {
                font-size: 3.5rem;
            }

            .hero-question {
                font-size: 1.25rem;
            }

            .card {
                padding: 20px;
            }

            .hero-section {
                padding: 32px 20px;
            }

            .btn-row {
                flex-direction: column;
            }

            .score-bar-labels {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/veritas-logo-horizontal.png" alt="VERITAS LLC" onerror="this.style.display='none'">
                <span class="tagline">Truth through Transparency</span>
            </div>
            <span class="version-badge">VERACITY ENGINE‚Ñ¢ v3.7</span>
        </div>
    </header>

    <div class="container">
        <!-- Input Card -->
        <div class="card">
            <div class="error" id="errorBox"></div>

            <div class="mode-toggle">
                <button type="button" class="mode-tab active" id="questionModeTab" onclick="setMode('question')">
                    ‚ùì Research Question
                </button>
                <button type="button" class="mode-tab" id="articleModeTab" onclick="setMode('article')">
                    üì∞ Assess Article
                </button>
            </div>

            <div class="mode-hint" id="modeHint">
                Enter a claim or question and VERITAS will search for evidence and provide an assessment.
            </div>

            <div class="url-field" id="urlField">
                <label for="articleUrl">Article URL</label>
                <input type="text" id="articleUrl" placeholder="https://example.com/article...">
                <small>Providing the source URL helps VERITAS verify the article's context and credibility</small>
            </div>

            <div class="form-group">
                <label for="question" id="questionLabel">Question or Claim to Assess</label>
                <div class="input-wrapper">
                    <textarea id="question" maxlength="600" placeholder="Enter ONE specific claim to assess (e.g., 'Climate change is primarily caused by human activity')" oninput="updateCharCounter()"></textarea>
                    <div class="char-counter green" id="charCounter">0 / 280 characters</div>
                    <div class="char-warning" id="charWarning">‚ö†Ô∏è That's getting long! For the best assessment, try to focus on ONE specific claim. Can you simplify?</div>
                </div>
                <p class="input-tip">üí° <strong>Tip:</strong> One claim at a time works best. Keep it under 280 characters for optimal results.</p>
            </div>

            <div class="form-group">
                <label for="articleText">Article Text (Optional)</label>
                <textarea id="articleText" placeholder="Paste article text here for analysis, or leave blank to assess just the question above..."></textarea>
            </div>

            <details class="api-key-section">
                <summary>Use Your Own API Key (Optional)</summary>
                <p>Get unlimited assessments by using your own Anthropic API key. Without a key, you get 5 free assessments per day.</p>
                <input type="text" id="apiKey" placeholder="sk-ant-...">
            </details>

            <div class="btn-row">
                <button class="btn btn-clear" onclick="clearForm()">üóëÔ∏è Clear</button>
                <button class="btn btn-primary" id="assessBtn" onclick="runAssessment()">Assess with VERITAS</button>
            </div>
            <p class="free-tier-note">5 free assessments per day ‚Ä¢ Powered by Claude with web search</p>
        </div>

        <!-- Results Section -->
        <div class="results" id="results">
            <!-- Hero Score Display -->
            <div class="hero-section">
                <div class="hero-badge">
                    <img src="/veritas-logo-horizontal.png" alt="VERITAS" style="height: 20px; filter: brightness(0) invert(1);" onerror="this.parentElement.innerHTML='<span>VERITAS</span>'">
                </div>
                <div class="hero-score positive" id="heroScore">+8</div>
                <div class="hero-question" id="heroQuestion">Do dogs dream in their sleep?</div>
                <div class="hero-subtitle">Reality Score: Is the claim TRUE or FALSE?</div>
            </div>

            <!-- Score Bars -->
            <div class="score-bars-container">
                <div class="score-bar-wrapper">
                    <div class="score-bar-header">
                        <span class="score-bar-title">Reality Score:</span>
                        <span class="score-bar-value" id="realityScoreDisplay">+8</span>
                    </div>
                    <div class="score-bar-container">
                        <div class="score-bar-gradient reality"></div>
                        <div class="score-bar-marker" id="realityMarker" style="left: 90%;"></div>
                    </div>
                    <div class="score-bar-labels">
                        <span>-10<br>FALSE</span>
                        <span>-5</span>
                        <span>0<br>UNCERTAIN</span>
                        <span>+5</span>
                        <span>+10<br>TRUE</span>
                    </div>
                </div>

                <div class="score-bar-wrapper">
                    <div class="score-bar-header">
                        <span class="score-bar-title">Integrity Score:</span>
                        <span class="score-bar-value" id="integrityScoreDisplay">+0.90</span>
                    </div>
                    <div class="score-bar-container">
                        <div class="score-bar-gradient integrity"></div>
                        <div class="score-bar-marker" id="integrityMarker" style="left: 95%;"></div>
                    </div>
                    <div class="score-bar-labels">
                        <span>-1.0<br>Deceptive</span>
                        <span>-0.5<br>Dishonest</span>
                        <span>0<br>Neutral</span>
                        <span>+0.5<br>Good</span>
                        <span>+1.0<br>Honest</span>
                    </div>
                </div>
            </div>

            <!-- Assessment Content -->
            <div class="card">
                <div id="formattedAssessment"></div>
            </div>

            <!-- Amplify Button -->
            <button class="btn btn-amplify" id="amplifyBtn" onclick="runAmplify()">
                üîç Amplify Assessment ‚Äî Deeper Analysis
            </button>

            <!-- Amplified Results -->
            <div class="amplified-results" id="amplifiedResults">
                <div class="amplified-header">
                    <span style="font-size: 1.5rem;">‚ñ≤</span>
                    <h3>Amplified Analysis</h3>
                </div>
                <div id="formattedAmplified"></div>
            </div>
        </div>
    </div>

    <script>
        var lastAssessment = null;
        var currentMode = 'question';
        var currentQuestion = '';

        // Character counter function
        function updateCharCounter() {
            var question = document.getElementById('question');
            var counter = document.getElementById('charCounter');
            var warning = document.getElementById('charWarning');
            var len = question.value.length;
            
            counter.textContent = len + ' / 280 characters';
            
            // Update color based on length
            counter.classList.remove('green', 'yellow', 'red');
            if (len <= 200) {
                counter.classList.add('green');
            } else if (len <= 280) {
                counter.classList.add('yellow');
            } else {
                counter.classList.add('red');
            }
            
            // Show warning if over 400 characters
            if (len > 400) {
                warning.classList.add('visible');
            } else {
                warning.classList.remove('visible');
            }
        }

        function setMode(mode) {
            currentMode = mode;
            var questionTab = document.getElementById('questionModeTab');
            var articleTab = document.getElementById('articleModeTab');
            var urlField = document.getElementById('urlField');
            var modeHint = document.getElementById('modeHint');
            var questionLabel = document.getElementById('questionLabel');
            var articleTextarea = document.getElementById('articleText');
            var questionInput = document.getElementById('question');
            
            if (mode === 'article') {
                questionTab.classList.remove('active');
                articleTab.classList.add('active');
                urlField.classList.add('visible');
                modeHint.innerHTML = 'Paste the article text below. Providing the URL helps VERITAS verify source credibility.';
                questionLabel.textContent = 'What aspect to assess? (Optional)';
                questionInput.placeholder = 'e.g., Is this article accurate? What claims need verification?';
                articleTextarea.placeholder = 'Paste the full article text here for assessment...';
            } else {
                articleTab.classList.remove('active');
                questionTab.classList.add('active');
                urlField.classList.remove('visible');
                modeHint.innerHTML = 'Enter a claim or question and VERITAS will search for evidence and provide an assessment.';
                questionLabel.textContent = 'Question or Claim to Assess';
                questionInput.placeholder = 'Enter ONE specific claim to assess (e.g., \'Climate change is primarily caused by human activity\')';
                articleTextarea.placeholder = 'Paste article text here for analysis, or leave blank to assess just the question above...';
            }
        }

        function clearForm() {
            document.getElementById('question').value = '';
            document.getElementById('articleText').value = '';
            document.getElementById('articleUrl').value = '';
            document.getElementById('errorBox').classList.remove('visible');
            document.getElementById('results').classList.remove('visible');
            document.getElementById('amplifiedResults').classList.remove('visible');
            // Reset character counter
            updateCharCounter();;
            document.getElementById('amplifiedResults').classList.remove('visible');
            document.getElementById('amplifyBtn').style.display = 'block';
            lastAssessment = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateScoreDisplay(realityScore, integrityScore) {
            // Update hero score
            var heroScoreEl = document.getElementById('heroScore');
            var heroQuestionEl = document.getElementById('heroQuestion');
            
            if (realityScore !== null && realityScore !== undefined) {
                var scoreNum = parseFloat(realityScore);
                heroScoreEl.textContent = (scoreNum >= 0 ? '+' : '') + scoreNum;
                
                // Color based on score
                heroScoreEl.classList.remove('positive', 'negative', 'neutral');
                if (scoreNum >= 3) {
                    heroScoreEl.classList.add('positive');
                } else if (scoreNum <= -3) {
                    heroScoreEl.classList.add('negative');
                } else {
                    heroScoreEl.classList.add('neutral');
                }
                
                // Update reality score bar
                document.getElementById('realityScoreDisplay').textContent = (scoreNum >= 0 ? '+' : '') + scoreNum;
                var realityPercent = ((scoreNum + 10) / 20) * 100;
                document.getElementById('realityMarker').style.left = realityPercent + '%';
            } else {
                heroScoreEl.textContent = '-';
                document.getElementById('realityScoreDisplay').textContent = '-';
            }
            
            // Update question display
            heroQuestionEl.textContent = currentQuestion || 'Assessment Complete';
            
            // Update integrity score bar
            if (integrityScore !== null && integrityScore !== undefined) {
                var integrityNum = parseFloat(integrityScore);
                document.getElementById('integrityScoreDisplay').textContent = (integrityNum >= 0 ? '+' : '') + integrityNum.toFixed(2);
                var integrityPercent = ((integrityNum + 1) / 2) * 100;
                document.getElementById('integrityMarker').style.left = integrityPercent + '%';
            } else {
                document.getElementById('integrityScoreDisplay').textContent = '-';
            }
        }

        function formatAssessment(text) {
            var sections = [
                { pattern: /\*\*(?:THE )?UNDERLYING (?:TRUTH|REALITY)\*\*/i, title: 'The Underlying Reality', cls: 'section-truth' },
                { pattern: /\*\*VERITAS ASSESSMENT\*\*/i, title: 'VERITAS Assessment', cls: 'section-assessment' },
                { pattern: /\*\*CLAIM BEING TESTED\*\*/i, title: 'Claim Being Tested', cls: 'section-claim' },
                { pattern: /\*\*(?:THE )?CENTRAL CLAIMS?\*\*/i, title: 'The Central Claims', cls: 'section-claim' },
                { pattern: /\*\*EVIDENCE ANALYSIS\*\*/i, title: 'Evidence Analysis', cls: 'section-evidence' },
                { pattern: /\*\*TRUTH DISTORTION (?:ANALYSIS|PATTERNS)\*\*/i, title: 'Truth Distortion Analysis', cls: 'section-distortion' },
                { pattern: /\*\*EXAMINING THE QUESTION'?S? FRAMEWORK\*\*/i, title: "Examining the Question's Framework", cls: 'section-framework' },
                { pattern: /\*\*INTEGRITY ANALYSIS\*\*/i, title: 'Integrity Analysis', cls: 'section-integrity' },
                { pattern: /\*\*WHAT WE CAN BE CONFIDENT ABOUT\*\*/i, title: 'What We Can Be Confident About', cls: 'section-confident' },
                { pattern: /\*\*WHAT REMAINS (?:GENUINELY )?UNCERTAIN\*\*/i, title: 'What Remains Uncertain', cls: 'section-uncertain' },
                { pattern: /\*\*BOTTOM LINE\*\*/i, title: 'Bottom Line', cls: 'section-bottom' },
                { pattern: /\*\*LESSONS FOR INFORMATION ASSESSMENT\*\*/i, title: 'Lessons for Information Assessment', cls: 'section-lessons' },
                { pattern: /\*\*METHODOLOGY NOTES?\*\*/i, title: 'Methodology Notes', cls: 'section-methodology' },
                { pattern: /\*\*KEY SOURCES(?: REFERENCED)?\*\*/i, title: 'Key Sources', cls: 'section-sources' }
            ];
            
            var cleanText = text;
            cleanText = cleanText.replace(/\*\*REALITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*EPISTEMOLOGICAL INTEGRITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*INTEGRITY SCORE:[^*]*\*\*/gi, '');
            
            var html = '';
            var i, j, section, match, startIdx, endIdx, nextMatch, content;
            
            for (i = 0; i < sections.length; i++) {
                section = sections[i];
                match = cleanText.match(section.pattern);
                if (match) {
                    startIdx = match.index + match[0].length;
                    endIdx = cleanText.length;
                    
                    for (j = i + 1; j < sections.length; j++) {
                        nextMatch = cleanText.substring(startIdx).match(sections[j].pattern);
                        if (nextMatch) {
                            endIdx = startIdx + nextMatch.index;
                            break;
                        }
                    }
                    
                    content = cleanText.substring(startIdx, endIdx).trim();
                    content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    content = formatListsAndParagraphs(content);
                    
                    if (content) {
                        html += '<div class="assessment-section ' + section.cls + '">';
                        html += '<h3>' + section.title + '</h3>';
                        html += content;
                        html += '</div>';
                    }
                }
            }
            
            if (!html) {
                html = '<div class="assessment-section"><p>' + text.replace(/\n/g, '<br>') + '</p></div>';
            }
            
            return html;
        }

        function formatListsAndParagraphs(content) {
            // Split by double newlines for paragraphs
            var lines = content.split('\n');
            var result = '';
            var inList = false;
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                // Check if it's a bullet point
                if (line.match(/^[‚Ä¢\-\*]\s+/)) {
                    if (!inList) {
                        result += '<ul>';
                        inList = true;
                    }
                    result += '<li>' + line.replace(/^[‚Ä¢\-\*]\s+/, '') + '</li>';
                } else {
                    if (inList) {
                        result += '</ul>';
                        inList = false;
                    }
                    result += '<p>' + line + '</p>';
                }
            }
            
            if (inList) {
                result += '</ul>';
            }
            
            return result;
        }

        function formatAmplified(text) {
            var sections = [
                { pattern: /\*\*AMPLIFI(?:CATION|ED(?: ANALYSIS)?) SUMMARY\*\*/i, title: 'üîç Amplified Analysis Summary', icon: '' },
                { pattern: /\*\*MISSING PERSPECTIVES\*\*/i, title: 'üåê Missing Perspectives', icon: '' },
                { pattern: /\*\*ALTERNATIVE FRAMINGS?\*\*/i, title: 'üîÑ Alternative Framings', icon: '' },
                { pattern: /\*\*WHAT WOULD CHANGE (?:THE|THIS) ASSESSMENT\??\*\*/i, title: 'üîÆ What Would Change This Assessment?', icon: '' },
                { pattern: /\*\*UNCERTAINTY CATEGORIZATION\*\*/i, title: 'üìä Uncertainty Categorization', icon: '' },
                { pattern: /\*\*EPISTEMIC HUMILITY CHECK\*\*/i, title: 'ü§î Epistemic Humility Check', icon: '' },
                { pattern: /\*\*BOTTOM LINE\*\*/i, title: '‚úÖ Bottom Line', icon: '' }
            ];
            
            var html = '';
            var i, j, section, match, startIdx, endIdx, nextMatch, content;
            
            for (i = 0; i < sections.length; i++) {
                section = sections[i];
                match = text.match(section.pattern);
                if (match) {
                    startIdx = match.index + match[0].length;
                    endIdx = text.length;
                    
                    for (j = i + 1; j < sections.length; j++) {
                        nextMatch = text.substring(startIdx).match(sections[j].pattern);
                        if (nextMatch) {
                            endIdx = startIdx + nextMatch.index;
                            break;
                        }
                    }
                    
                    content = text.substring(startIdx, endIdx).trim();
                    content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    content = formatListsAndParagraphs(content);
                    
                    if (content) {
                        html += '<div class="amplified-section">';
                        html += '<h4>' + section.title + '</h4>';
                        html += content;
                        html += '</div>';
                    }
                }
            }
            
            if (!html) {
                html = '<div class="amplified-section"><p>' + text.replace(/\n/g, '<br>') + '</p></div>';
            }
            
            return html;
        }

        function runAssessment() {
            var question = document.getElementById('question').value.trim();
            var articleText = document.getElementById('articleText').value.trim();
            var articleUrl = document.getElementById('articleUrl').value.trim();
            var userApiKey = document.getElementById('apiKey').value.trim();
            var btn = document.getElementById('assessBtn');
            var errorBox = document.getElementById('errorBox');
            var results = document.getElementById('results');

            // Validation based on mode
            if (currentMode === 'article') {
                if (!articleText && !articleUrl) {
                    errorBox.textContent = 'Please provide an article URL or paste the article text.';
                    errorBox.classList.add('visible');
                    return;
                }
            } else {
                if (!question && !articleText) {
                    errorBox.textContent = 'Please enter a question or paste article text.';
                    errorBox.classList.add('visible');
                    return;
                }
            }

            // Build article context
            var finalArticleText = '';
            if (articleUrl && articleText) {
                finalArticleText = 'SOURCE URL: ' + articleUrl + '\n\nARTICLE TEXT:\n' + articleText;
            } else if (articleUrl) {
                finalArticleText = 'SOURCE URL: ' + articleUrl + '\n\nPlease fetch and analyze this article using web search.';
            } else if (articleText) {
                finalArticleText = articleText;
            }
            
            // Default question for URL-only article assessment
            var finalQuestion = question;
            if (currentMode === 'article' && !question && articleUrl) {
                finalQuestion = 'Assess the accuracy and epistemological integrity of this article.';
            }

            // Store question for display
            currentQuestion = finalQuestion || 'Article Assessment';

            errorBox.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'Analyzing with web search...';
            results.classList.remove('visible');
            document.getElementById('amplifiedResults').classList.remove('visible');
            document.getElementById('amplifyBtn').style.display = 'block';

            var requestBody = {
                question: finalQuestion,
                articleText: finalArticleText,
                userApiKey: userApiKey
            };

            fetch('/api/assess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                var contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server error - please try again. If assessing a URL, try pasting the article text instead.');
                }
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Assessment failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                updateScoreDisplay(data.realityScore, data.integrityScore);
                document.getElementById('formattedAssessment').innerHTML = formatAssessment(data.assessment);
                results.classList.add('visible');

                lastAssessment = {
                    question: finalQuestion || 'Article Assessment',
                    assessment: data.assessment
                };

                results.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                errorBox.textContent = 'Error: ' + err.message;
                errorBox.classList.add('visible');
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Assess with VERITAS';
            });
        }

        function truncateForAmplify(assessment) {
            if (assessment.length > 4000) {
                return assessment.substring(0, 4000) + '\n\n[...Assessment truncated for amplification analysis...]';
            }
            return assessment;
        }

        function runAmplify() {
            if (!lastAssessment) return;

            var btn = document.getElementById('amplifyBtn');
            var userApiKey = document.getElementById('apiKey').value.trim();

            btn.disabled = true;
            btn.textContent = 'üîç Amplifying...';

            var truncatedAssessment = truncateForAmplify(lastAssessment.assessment);

            var requestBody = {
                question: lastAssessment.question,
                assessment: truncatedAssessment,
                userApiKey: userApiKey
            };

            fetch('/api/amplify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Amplification failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                document.getElementById('formattedAmplified').innerHTML = formatAmplified(data.amplified);
                document.getElementById('amplifiedResults').classList.add('visible');
                btn.style.display = 'none';
                document.getElementById('amplifiedResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                alert('Amplification error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'üîç Amplify Assessment ‚Äî Deeper Analysis';
            });
        }
    </script>
</body>
</html>
