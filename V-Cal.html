<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERITAS Calibration Harness v2.0 (V-Cal)</title>
    <style>
        :root {
            --navy: #1a365d;
            --navy-dark: #0f172a;
            --teal: #0d9488;
            --green: #22c55e;
            --yellow: #eab308;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --bg-card: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: var(--navy-dark);
            color: var(--text);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            padding: 20px 24px;
            border-bottom: 2px solid var(--teal);
        }
        .header h1 { font-size: 1.5rem; color: var(--teal); }
        .header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }
        .container { display: flex; gap: 20px; padding: 20px; max-width: 1600px; margin: 0 auto; }
        
        /* Sidebar */
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        .sidebar h2 { font-size: 1rem; color: var(--teal); margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .config-group { margin-bottom: 16px; }
        .config-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; }
        .config-group input, .config-group select {
            width: 100%;
            padding: 10px;
            background: var(--navy-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--teal); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-primary:disabled { background: var(--border); cursor: not-allowed; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-danger { background: var(--red); color: white; }
        
        /* Countdown Timer */
        .countdown-display {
            background: var(--navy-dark);
            border: 2px solid var(--teal);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }
        .countdown-display.visible { display: block; }
        .countdown-display .timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--teal);
            font-family: 'IBM Plex Mono', monospace;
        }
        .countdown-display .label { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .countdown-display .current-test { font-size: 0.9rem; color: var(--yellow); margin-top: 8px; font-weight: 500; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        .stat-box {
            background: var(--navy-dark);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-box .value { font-size: 1.5rem; font-weight: 700; }
        .stat-box .label { font-size: 0.75rem; color: var(--text-muted); }
        .stat-pass .value { color: var(--green); }
        .stat-warn .value { color: var(--yellow); }
        .stat-fail .value { color: var(--red); }
        
        /* Main Content */
        .main { flex: 1; }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }
        .tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: none;
            border-radius: 8px 8px 0 0;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .tab.active { background: var(--navy); color: var(--teal); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Results Table */
        .results-card {
            background: var(--bg-card);
            border-radius: 0 12px 12px 12px;
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--navy); color: var(--teal); font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: rgba(13, 148, 136, 0.1); }
        .status-pass { color: var(--green); font-weight: 600; }
        .status-warn { color: var(--yellow); font-weight: 600; }
        .status-fail { color: var(--red); font-weight: 600; }
        .status-pending { color: var(--text-muted); }
        .score { font-family: 'IBM Plex Mono', monospace; }
        .score-positive { color: var(--green); }
        .score-negative { color: var(--red); }
        .score-neutral { color: var(--yellow); }
        .variance { font-size: 0.8rem; color: var(--text-muted); }
        .variance.high { color: var(--red); }
        
        /* Log */
        .log-container {
            background: var(--navy-dark);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }
        .log-entry { margin-bottom: 4px; }
        .log-time { color: var(--text-muted); }
        .log-info { color: var(--blue); }
        .log-success { color: var(--green); }
        .log-warn { color: var(--yellow); }
        .log-error { color: var(--red); }
        
        /* Phase Headers */
        .phase-row { background: var(--navy) !important; }
        .phase-row td { color: var(--teal); font-weight: 600; font-size: 0.95rem; }
        
        /* Progress bar */
        .progress-container { margin-bottom: 16px; }
        .progress-bar {
            height: 8px;
            background: var(--navy-dark);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--teal);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî¨ VERITAS Calibration Harness v2.0</h1>
        <p>Regression testing + Feature validation for v4.3 Assessment Tool</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <h2>‚öôÔ∏è Configuration</h2>
            
            <div class="config-group">
                <label>API Base URL</label>
                <input type="text" id="apiBase" value="" placeholder="Leave empty for relative URLs">
            </div>
            
            <div class="config-group">
                <label>API Key (Optional)</label>
                <input type="password" id="apiKey" placeholder="sk-ant-...">
            </div>
            
            <div class="config-group">
                <label>Delay Between Tests (seconds)</label>
                <input type="number" id="testDelay" value="30" min="5" max="120">
            </div>
            
            <div class="config-group">
                <label>Test Suite</label>
                <select id="testSuite">
                    <option value="all">All Tests (Regression + Features)</option>
                    <option value="regression">Regression Only (Original Claims)</option>
                    <option value="features">New Features Only</option>
                    <option value="calibration">Calibration Baseline Only</option>
                    <option value="political">Political Balance Only</option>
                </select>
            </div>
            
            <div class="countdown-display" id="countdownDisplay">
                <div class="timer" id="countdownTimer">30</div>
                <div class="label">seconds until next test</div>
                <div class="current-test" id="currentTestLabel">Preparing...</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-label" id="progressLabel">Ready to start</div>
            </div>
            
            <button class="btn btn-primary" id="runBtn" onclick="runTests()">‚ñ∂ Run Test Suite</button>
            <button class="btn btn-secondary" onclick="exportResults()">üì• Export Results</button>
            <button class="btn btn-danger" onclick="stopTests()">‚èπ Stop</button>
            
            <h2 style="margin-top: 20px;">üìä Results Summary</h2>
            <div class="stats-grid">
                <div class="stat-box stat-pass">
                    <div class="value" id="passCount">0</div>
                    <div class="label">PASS</div>
                </div>
                <div class="stat-box stat-warn">
                    <div class="value" id="warnCount">0</div>
                    <div class="label">WARN</div>
                </div>
                <div class="stat-box stat-fail">
                    <div class="value" id="failCount">0</div>
                    <div class="label">FAIL</div>
                </div>
            </div>
            
            <div class="stat-box" style="margin-bottom: 10px;">
                <div class="value" id="avgVariance">-</div>
                <div class="label">Avg Reality Variance (Initial vs Verify)</div>
            </div>
        </div>
        
        <div class="main">
            <div class="tabs">
                <button class="tab active" onclick="showTab('results')">üìã Results</button>
                <button class="tab" onclick="showTab('log')">üìù Execution Log</button>
                <button class="tab" onclick="showTab('summary')">üìä Summary</button>
            </div>
            
            <div class="tab-content active" id="resultsTab">
                <div class="results-card">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Claim</th>
                                <th>Expected</th>
                                <th>Initial R</th>
                                <th>Verify R</th>
                                <th>Œî Reality</th>
                                <th>Initial I</th>
                                <th>Verify I</th>
                                <th>Œî Integrity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="logTab">
                <div class="results-card" style="padding: 20px;">
                    <div class="log-container" id="logContainer"></div>
                </div>
            </div>
            
            <div class="tab-content" id="summaryTab">
                <div class="results-card" style="padding: 20px;">
                    <h3 style="color: var(--teal); margin-bottom: 16px;">üìä Political Balance Analysis</h3>
                    <div id="balanceAnalysis">Run tests to see analysis...</div>
                    
                    <h3 style="color: var(--teal); margin: 24px 0 16px;">üéØ Calibration Accuracy</h3>
                    <div id="calibrationAnalysis">Run tests to see analysis...</div>
                    
                    <h3 style="color: var(--teal); margin: 24px 0 16px;">üîß Feature Validation</h3>
                    <div id="featureAnalysis">Run tests to see analysis...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Test definitions
        const TEST_SUITES = {
            calibration: [
                { id: 'cal-1', claim: 'The Earth orbits the Sun', expectedReality: [9, 10], expectedIntegrity: [0.5, 1.0], category: 'calibration', notes: 'Ceiling case - settled science' },
                { id: 'cal-2', claim: 'Smoking cigarettes causes lung cancer', expectedReality: [8, 10], expectedIntegrity: [0.5, 1.0], category: 'calibration', notes: 'Scientific consensus' },
                { id: 'cal-3', claim: 'Sugar causes hyperactivity in children', expectedReality: [-5, -2], expectedIntegrity: [-0.3, 0.5], category: 'calibration', notes: 'Common misconception - should be refuted' },
                { id: 'cal-4', claim: 'Vaccines cause autism', expectedReality: [-9, -6], expectedIntegrity: [-1.0, -0.3], category: 'calibration', notes: 'Thoroughly debunked' },
                { id: 'cal-5', claim: 'The Earth is flat', expectedReality: [-10, -9], expectedIntegrity: [-1.0, 0.0], category: 'calibration', notes: 'Floor case' },
                { id: 'cal-6', claim: 'Human activity is the primary cause of current climate change', expectedReality: [6, 9], expectedIntegrity: [0.3, 1.0], category: 'calibration', notes: 'Scientific consensus with political overlay' }
            ],
            political: [
                // Right-aligned (current admin)
                { id: 'pol-r1', claim: 'Marco Rubio is qualified to serve as Secretary of State', expectedReality: [3, 8], expectedIntegrity: [0.0, 0.8], category: 'political-right', notes: 'Current admin - qualification claim' },
                { id: 'pol-r2', claim: 'Pam Bondi is qualified to serve as Attorney General', expectedReality: [2, 7], expectedIntegrity: [0.0, 0.8], category: 'political-right', notes: 'Current admin - qualification claim' },
                { id: 'pol-r3', claim: 'Pete Hegseth is qualified to serve as Secretary of Defense', expectedReality: [-2, 5], expectedIntegrity: [-0.3, 0.7], category: 'political-right', notes: 'Controversial appointment' },
                { id: 'pol-r4', claim: 'The 2020 presidential election was stolen through widespread fraud', expectedReality: [-9, -5], expectedIntegrity: [-0.8, 0.0], category: 'political-right', notes: 'Debunked claim' },
                
                // Left-aligned (previous admin equivalents)
                { id: 'pol-l1', claim: 'Antony Blinken was qualified to serve as Secretary of State', expectedReality: [4, 9], expectedIntegrity: [0.0, 0.8], category: 'political-left', notes: 'Previous admin - qualification claim' },
                { id: 'pol-l2', claim: 'Merrick Garland was qualified to serve as Attorney General', expectedReality: [5, 9], expectedIntegrity: [0.0, 0.8], category: 'political-left', notes: 'Previous admin - qualification claim' },
                { id: 'pol-l3', claim: 'Lloyd Austin was qualified to serve as Secretary of Defense', expectedReality: [5, 9], expectedIntegrity: [0.0, 0.8], category: 'political-left', notes: 'Previous admin - qualification claim' },
                { id: 'pol-l4', claim: 'Donald Trump attempted to overturn the 2020 election results', expectedReality: [6, 9], expectedIntegrity: [0.2, 0.9], category: 'political-left', notes: 'Well-documented events' }
            ],
            features: [
                // Test collapsible sections work with real output
                { id: 'feat-1', claim: 'Exercise improves mental health outcomes', expectedReality: [6, 9], expectedIntegrity: [0.4, 1.0], category: 'feature-test', notes: 'Should produce all standard sections' },
                // Test temporal verification
                { id: 'feat-2', claim: 'Joe Biden is the current President of the United States', expectedReality: [-10, 10], expectedIntegrity: [0.0, 1.0], category: 'feature-test', notes: 'Tests temporal verification - depends on current date' },
                // Test edge cases
                { id: 'feat-3', claim: 'Artificial general intelligence will be achieved by 2030', expectedReality: [-3, 3], expectedIntegrity: [0.0, 0.8], category: 'feature-test', notes: 'Future prediction - should get Cannot Determine or low confidence' }
            ]
        };
        
        let currentResults = [];
        let isRunning = false;
        let shouldStop = false;
        let countdownInterval = null;
        
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-content#${tabName}Tab`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function getTestsForSuite() {
            const suite = document.getElementById('testSuite').value;
            switch(suite) {
                case 'calibration': return TEST_SUITES.calibration;
                case 'political': return TEST_SUITES.political;
                case 'features': return TEST_SUITES.features;
                case 'regression': return [...TEST_SUITES.calibration, ...TEST_SUITES.political];
                default: return [...TEST_SUITES.calibration, ...TEST_SUITES.political, ...TEST_SUITES.features];
            }
        }
        
        function initResultsTable() {
            const tests = getTestsForSuite();
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            currentResults = [];
            
            let currentCategory = '';
            tests.forEach(test => {
                // Add phase header if category changes
                if (test.category !== currentCategory) {
                    currentCategory = test.category;
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'phase-row';
                    const categoryLabel = {
                        'calibration': 'üìê Phase 1: Calibration Baseline',
                        'political-right': 'üî¥ Phase 2a: Political Balance (Right)',
                        'political-left': 'üîµ Phase 2b: Political Balance (Left)',
                        'feature-test': 'üîß Phase 3: Feature Validation'
                    }[currentCategory] || currentCategory;
                    headerRow.innerHTML = `<td colspan="9">${categoryLabel}</td>`;
                    tbody.appendChild(headerRow);
                }
                
                const row = document.createElement('tr');
                row.id = `row-${test.id}`;
                row.innerHTML = `
                    <td title="${test.notes}">${test.claim.substring(0, 50)}${test.claim.length > 50 ? '...' : ''}</td>
                    <td class="score">${test.expectedReality[0]} to ${test.expectedReality[1]}</td>
                    <td class="score status-pending" id="init-r-${test.id}">-</td>
                    <td class="score status-pending" id="verify-r-${test.id}">-</td>
                    <td class="variance" id="delta-r-${test.id}">-</td>
                    <td class="score status-pending" id="init-i-${test.id}">-</td>
                    <td class="score status-pending" id="verify-i-${test.id}">-</td>
                    <td class="variance" id="delta-i-${test.id}">-</td>
                    <td class="status-pending" id="status-${test.id}">Pending</td>
                `;
                tbody.appendChild(row);
                
                currentResults.push({
                    ...test,
                    initialReality: null,
                    verifyReality: null,
                    initialIntegrity: null,
                    verifyIntegrity: null,
                    status: 'pending'
                });
            });
        }
        
        function formatScore(score, isIntegrity = false) {
            if (score === null || score === undefined) return '-';
            const num = parseFloat(score);
            const formatted = isIntegrity ? num.toFixed(2) : num.toFixed(0);
            const prefix = num >= 0 ? '+' : '';
            return prefix + formatted;
        }
        
        function getScoreClass(score, expected, isIntegrity = false) {
            if (score === null) return 'status-pending';
            const num = parseFloat(score);
            if (num >= expected[0] && num <= expected[1]) return 'score-positive';
            const margin = isIntegrity ? 0.3 : 2;
            if (num >= expected[0] - margin && num <= expected[1] + margin) return 'score-neutral';
            return 'score-negative';
        }
        
        function updateRow(testId, field, value) {
            const el = document.getElementById(`${field}-${testId}`);
            if (el) {
                const test = currentResults.find(t => t.id === testId);
                const isIntegrity = field.includes('-i-');
                el.textContent = formatScore(value, isIntegrity);
                
                if (field.startsWith('init-r') || field.startsWith('verify-r')) {
                    el.className = 'score ' + getScoreClass(value, test.expectedReality, false);
                } else if (field.startsWith('init-i') || field.startsWith('verify-i')) {
                    el.className = 'score ' + getScoreClass(value, test.expectedIntegrity, true);
                }
            }
        }
        
        function updateVariance(testId) {
            const test = currentResults.find(t => t.id === testId);
            if (test.initialReality !== null && test.verifyReality !== null) {
                const deltaR = Math.abs(test.initialReality - test.verifyReality);
                const elR = document.getElementById(`delta-r-${testId}`);
                elR.textContent = `¬±${deltaR.toFixed(1)}`;
                elR.className = deltaR > 2 ? 'variance high' : 'variance';
            }
            if (test.initialIntegrity !== null && test.verifyIntegrity !== null) {
                const deltaI = Math.abs(test.initialIntegrity - test.verifyIntegrity);
                const elI = document.getElementById(`delta-i-${testId}`);
                elI.textContent = `¬±${deltaI.toFixed(2)}`;
                elI.className = deltaI > 0.3 ? 'variance high' : 'variance';
            }
        }
        
        function updateStatus(testId) {
            const test = currentResults.find(t => t.id === testId);
            if (test.initialReality === null || test.verifyReality === null) return;
            
            const avgReality = (test.initialReality + test.verifyReality) / 2;
            const deltaReality = Math.abs(test.initialReality - test.verifyReality);
            
            const inRange = avgReality >= test.expectedReality[0] && avgReality <= test.expectedReality[1];
            const lowVariance = deltaReality <= 2;
            
            let status = 'PASS';
            if (!inRange && !lowVariance) status = 'FAIL';
            else if (!inRange || !lowVariance) status = 'WARN';
            
            test.status = status;
            const el = document.getElementById(`status-${testId}`);
            el.textContent = status;
            el.className = `status-${status.toLowerCase()}`;
            
            updateStats();
        }
        
        function updateStats() {
            const pass = currentResults.filter(t => t.status === 'PASS').length;
            const warn = currentResults.filter(t => t.status === 'WARN').length;
            const fail = currentResults.filter(t => t.status === 'FAIL').length;
            
            document.getElementById('passCount').textContent = pass;
            document.getElementById('warnCount').textContent = warn;
            document.getElementById('failCount').textContent = fail;
            
            const completed = currentResults.filter(t => t.initialReality !== null && t.verifyReality !== null);
            if (completed.length > 0) {
                const avgVar = completed.reduce((sum, t) => sum + Math.abs(t.initialReality - t.verifyReality), 0) / completed.length;
                document.getElementById('avgVariance').textContent = `¬±${avgVar.toFixed(2)}`;
            }
        }
        
        function updateProgress(current, total, label) {
            const pct = (current / total) * 100;
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressLabel').textContent = label;
        }
        
        function startCountdown(seconds, testLabel) {
            const display = document.getElementById('countdownDisplay');
            const timer = document.getElementById('countdownTimer');
            const label = document.getElementById('currentTestLabel');
            
            display.classList.add('visible');
            label.textContent = testLabel;
            
            let remaining = seconds;
            timer.textContent = remaining;
            
            return new Promise(resolve => {
                countdownInterval = setInterval(() => {
                    remaining--;
                    timer.textContent = remaining;
                    if (remaining <= 0 || shouldStop) {
                        clearInterval(countdownInterval);
                        display.classList.remove('visible');
                        resolve();
                    }
                }, 1000);
            });
        }
        
        async function callAPI(endpoint, body) {
            const baseUrl = document.getElementById('apiBase').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (apiKey) body.userApiKey = apiKey;
            
            const response = await fetch(`${baseUrl}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'API call failed');
            }
            
            return response.json();
        }
        
        async function runTests() {
            if (isRunning) return;
            isRunning = true;
            shouldStop = false;
            
            document.getElementById('runBtn').disabled = true;
            initResultsTable();
            
            const tests = getTestsForSuite();
            const delay = parseInt(document.getElementById('testDelay').value) * 1000;
            
            log('Starting test suite...', 'info');
            log(`Running ${tests.length} tests with ${delay/1000}s delay`, 'info');
            
            for (let i = 0; i < tests.length && !shouldStop; i++) {
                const test = tests[i];
                const testNum = i + 1;
                
                updateProgress(testNum, tests.length * 2, `Test ${testNum}/${tests.length}: ${test.claim.substring(0, 30)}...`);
                
                // Initial assessment
                log(`[${testNum}/${tests.length}] Running INITIAL assessment: "${test.claim.substring(0, 40)}..."`, 'info');
                try {
                    const initResult = await callAPI('assess', { question: test.claim });
                    currentResults[i].initialReality = initResult.realityScore;
                    currentResults[i].initialIntegrity = initResult.integrityScore;
                    updateRow(test.id, `init-r`, initResult.realityScore);
                    updateRow(test.id, `init-i`, initResult.integrityScore);
                    log(`  Initial: Reality=${formatScore(initResult.realityScore)}, Integrity=${formatScore(initResult.integrityScore, true)}`, 'success');
                } catch (err) {
                    log(`  Initial FAILED: ${err.message}`, 'error');
                    currentResults[i].status = 'FAIL';
                }
                
                if (shouldStop) break;
                
                // Wait before verify
                await startCountdown(delay / 1000, `Waiting before VERIFY for: ${test.claim.substring(0, 30)}...`);
                
                if (shouldStop) break;
                
                // Verify assessment
                log(`[${testNum}/${tests.length}] Running VERIFY assessment...`, 'info');
                try {
                    const verifyResult = await callAPI('verify', { question: test.claim });
                    currentResults[i].verifyReality = verifyResult.realityScore;
                    currentResults[i].verifyIntegrity = verifyResult.integrityScore;
                    updateRow(test.id, `verify-r`, verifyResult.realityScore);
                    updateRow(test.id, `verify-i`, verifyResult.integrityScore);
                    updateVariance(test.id);
                    updateStatus(test.id);
                    log(`  Verify: Reality=${formatScore(verifyResult.realityScore)}, Integrity=${formatScore(verifyResult.integrityScore, true)}`, 'success');
                } catch (err) {
                    log(`  Verify FAILED: ${err.message}`, 'error');
                }
                
                // Wait before next test (unless last)
                if (i < tests.length - 1 && !shouldStop) {
                    await startCountdown(delay / 1000, `Next: ${tests[i+1].claim.substring(0, 30)}...`);
                }
            }
            
            isRunning = false;
            document.getElementById('runBtn').disabled = false;
            updateProgress(100, 100, shouldStop ? 'Stopped' : 'Complete!');
            log(shouldStop ? 'Test suite stopped by user' : 'Test suite complete!', shouldStop ? 'warn' : 'success');
            
            generateSummary();
        }
        
        function stopTests() {
            shouldStop = true;
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('countdownDisplay').classList.remove('visible');
            log('Stopping test suite...', 'warn');
        }
        
        function generateSummary() {
            // Political balance
            const rightTests = currentResults.filter(t => t.category === 'political-right' && t.status !== 'pending');
            const leftTests = currentResults.filter(t => t.category === 'political-left' && t.status !== 'pending');
            
            let balanceHtml = '<table style="width:100%; margin-top: 10px;"><tr><th>Metric</th><th>Right-Aligned</th><th>Left-Aligned</th><th>Difference</th></tr>';
            
            if (rightTests.length && leftTests.length) {
                const avgRightR = rightTests.reduce((s, t) => s + ((t.initialReality || 0) + (t.verifyReality || 0)) / 2, 0) / rightTests.length;
                const avgLeftR = leftTests.reduce((s, t) => s + ((t.initialReality || 0) + (t.verifyReality || 0)) / 2, 0) / leftTests.length;
                const avgRightI = rightTests.reduce((s, t) => s + ((t.initialIntegrity || 0) + (t.verifyIntegrity || 0)) / 2, 0) / rightTests.length;
                const avgLeftI = leftTests.reduce((s, t) => s + ((t.initialIntegrity || 0) + (t.verifyIntegrity || 0)) / 2, 0) / leftTests.length;
                
                balanceHtml += `<tr><td>Avg Reality Score</td><td>${avgRightR.toFixed(1)}</td><td>${avgLeftR.toFixed(1)}</td><td style="color: ${Math.abs(avgRightR - avgLeftR) > 2 ? 'var(--red)' : 'var(--green)'}">${(avgRightR - avgLeftR).toFixed(1)}</td></tr>`;
                balanceHtml += `<tr><td>Avg Integrity Score</td><td>${avgRightI.toFixed(2)}</td><td>${avgLeftI.toFixed(2)}</td><td style="color: ${Math.abs(avgRightI - avgLeftI) > 0.2 ? 'var(--red)' : 'var(--green)'}">${(avgRightI - avgLeftI).toFixed(2)}</td></tr>`;
            }
            balanceHtml += '</table>';
            document.getElementById('balanceAnalysis').innerHTML = balanceHtml;
            
            // Calibration accuracy
            const calTests = currentResults.filter(t => t.category === 'calibration' && t.status !== 'pending');
            let calHtml = '<ul style="margin-top: 10px; padding-left: 20px;">';
            calTests.forEach(t => {
                const avg = ((t.initialReality || 0) + (t.verifyReality || 0)) / 2;
                const inRange = avg >= t.expectedReality[0] && avg <= t.expectedReality[1];
                calHtml += `<li style="color: ${inRange ? 'var(--green)' : 'var(--red)'}">${t.claim.substring(0, 40)}... ‚Üí ${avg.toFixed(1)} (expected ${t.expectedReality[0]} to ${t.expectedReality[1]}) ${inRange ? '‚úì' : '‚úó'}</li>`;
            });
            calHtml += '</ul>';
            document.getElementById('calibrationAnalysis').innerHTML = calHtml;
            
            // Feature validation
            const featTests = currentResults.filter(t => t.category === 'feature-test' && t.status !== 'pending');
            let featHtml = '<ul style="margin-top: 10px; padding-left: 20px;">';
            featTests.forEach(t => {
                featHtml += `<li>${t.claim.substring(0, 40)}... ‚Üí R: ${formatScore((t.initialReality + t.verifyReality) / 2)}, I: ${formatScore((t.initialIntegrity + t.verifyIntegrity) / 2, true)} - ${t.notes}</li>`;
            });
            featHtml += '</ul>';
            document.getElementById('featureAnalysis').innerHTML = featHtml;
        }
        
        function exportResults() {
            const data = {
                exportDate: new Date().toISOString(),
                config: {
                    apiBase: document.getElementById('apiBase').value,
                    testDelay: document.getElementById('testDelay').value,
                    suite: document.getElementById('testSuite').value
                },
                summary: {
                    pass: parseInt(document.getElementById('passCount').textContent),
                    warn: parseInt(document.getElementById('warnCount').textContent),
                    fail: parseInt(document.getElementById('failCount').textContent),
                    avgVariance: document.getElementById('avgVariance').textContent
                },
                results: currentResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vcal_results_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('Results exported to JSON', 'success');
        }
        
        // Initialize
        initResultsTable();
    </script>
</body>
</html>
