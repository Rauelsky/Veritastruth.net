<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERITAS Assessment Tool v4.3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #2B7CD3;
            --navy: #1a365d;
            --navy-dark: #0f172a;
            --amplify-purple: #7c3aed;
            --amplify-purple-dark: #5b21b6;
            --track-b-teal: #0d9488;
            --track-b-teal-dark: #0f766e;
            --score-green: #22c55e;
            --score-yellow: #eab308;
            --score-red: #ef4444;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --bg-light: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        .site-header {
            background: white;
            border-bottom: 1px solid var(--border-light);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-section img {
            height: 40px;
            width: auto;
        }

        .tagline {
            color: var(--primary-blue);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .version-badge {
            background: var(--bg-light);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 20px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            margin-bottom: 24px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-light);
            background: var(--bg-light);
        }

        .mode-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            font-family: inherit;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .mode-tab:hover:not(.active) {
            background: var(--border-light);
        }

        /* Track A/B Toggle */
        .track-toggle {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-light);
            background: var(--bg-light);
        }

        .track-tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            font-family: inherit;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .track-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .track-tab.track-b.active {
            background: var(--track-b-teal);
        }

        .track-tab:hover:not(.active) {
            background: var(--border-light);
        }

        .track-description {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .track-description.track-b {
            background: #f0fdfa;
            border-color: #5eead4;
            color: #0f766e;
        }

        /* Track B Panels */
        .track-a-panel, .track-b-panel {
            display: none;
        }

        .track-a-panel.visible, .track-b-panel.visible {
            display: block;
        }

        /* Claim Type Selection (Track B) */
        .claim-type-confirmation {
            background: #f0fdfa;
            border: 2px solid #5eead4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .claim-type-confirmation h4 {
            color: var(--track-b-teal-dark);
            margin-bottom: 12px;
        }

        .claim-type-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .claim-type-option {
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .claim-type-option:hover {
            border-color: var(--track-b-teal);
        }

        .claim-type-option.selected {
            border-color: var(--track-b-teal);
            background: #f0fdfa;
        }

        .claim-type-option strong {
            display: block;
            color: var(--navy);
            margin-bottom: 2px;
        }

        .claim-type-option small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* 5 W's Input Fields (Track B) */
        .five-ws-inputs {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ws-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .ws-input-group label {
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        .ws-input-group input {
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        .ws-input-group input:focus {
            outline: none;
            border-color: var(--track-b-teal);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        /* Criteria Selection (Track B) */
        .criteria-selection {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .criteria-header h4 {
            color: var(--navy);
        }

        .criteria-count {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .criteria-count.full {
            color: var(--track-b-teal);
        }

        .criteria-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .criteria-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .criteria-item:hover:not(.disabled) {
            border-color: var(--track-b-teal);
        }

        .criteria-item.selected {
            border-color: var(--track-b-teal);
            background: #f0fdfa;
        }

        .criteria-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .criteria-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
            font-size: 14px;
            color: transparent;
        }

        .criteria-item.selected .criteria-checkbox {
            background: var(--track-b-teal);
            border-color: var(--track-b-teal);
            color: white;
        }

        .criteria-content strong {
            display: block;
            color: var(--navy);
            margin-bottom: 2px;
        }

        .criteria-content small {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Custom Criteria Input */
        .custom-criteria-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }

        .custom-criteria-row {
            display: flex;
            gap: 10px;
        }

        .custom-criteria-row input {
            flex: 1;
        }

        .btn-add-criteria {
            padding: 12px 20px;
            background: var(--track-b-teal);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add-criteria:hover {
            background: var(--track-b-teal-dark);
        }

        .custom-criteria-error {
            color: var(--score-red);
            font-size: 0.85rem;
            margin-top: 8px;
            display: none;
        }

        .custom-criteria-error.visible {
            display: block;
        }

        /* Track B Button */
        .btn-track-b {
            background: linear-gradient(135deg, var(--track-b-teal) 0%, var(--track-b-teal-dark) 100%);
            color: white;
            flex: 1;
        }

        .btn-track-b:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.35);
        }

        .btn-track-b:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Track B Results - Centered Bar Chart */
        .trackb-results {
            display: none;
            margin-top: 24px;
        }

        .trackb-results.visible {
            display: block;
        }

        /* Track B Amplify Button */
        .trackb-amplify-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            text-align: center;
        }
        .trackb-amplify-section .btn-amplify {
            background: linear-gradient(135deg, var(--track-b-teal) 0%, var(--track-b-teal-dark) 100%);
        }
        .trackb-amplify-section .btn-amplify:hover {
            background: linear-gradient(135deg, var(--track-b-teal-dark) 0%, #065f5a 100%);
        }

        .trackb-header {
            background: linear-gradient(135deg, var(--track-b-teal) 0%, var(--track-b-teal-dark) 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            margin: -28px -28px 24px -28px;
        }

        .trackb-header h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .trackb-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .criteria-result {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .criteria-result:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .criteria-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .criteria-result-label {
            font-weight: 600;
            color: var(--navy);
        }

        .criteria-result-score {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .criteria-result-score.positive { color: var(--score-green); }
        .criteria-result-score.negative { color: var(--score-red); }
        .criteria-result-score.neutral { color: var(--score-yellow); }

        /* Centered Bar */
        .centered-bar-container {
            position: relative;
            height: 32px;
            background: linear-gradient(to right, #fecaca 0%, #fef3c7 50%, #bbf7d0 100%);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .centered-bar-zero {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--text-muted);
        }

        .centered-bar-fill {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border-radius: 4px;
        }

        .centered-bar-fill.positive {
            left: 50%;
            background: var(--score-green);
        }

        .centered-bar-fill.negative {
            right: 50%;
            background: var(--score-red);
        }

        .centered-bar-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .criteria-result-summary {
            color: var(--text-dark);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .criteria-result-confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .criteria-result-confidence.high { background: #dcfce7; color: #166534; }
        .criteria-result-confidence.medium { background: #fef3c7; color: #92400e; }
        .criteria-result-confidence.low { background: #fee2e2; color: #991b1b; }

        /* Divergence Warning */
        .divergence-warning {
            display: none;
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .divergence-warning.visible {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .divergence-warning .icon {
            font-size: 1.5rem;
        }

        .divergence-warning h4 {
            color: #92400e;
            margin-bottom: 4px;
        }

        .divergence-warning p {
            color: #92400e;
            font-size: 0.9rem;
        }

        /* Full Picture Section */
        .full-picture {
            background: #f0fdfa;
            border: 2px solid #5eead4;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .full-picture h4 {
            color: var(--track-b-teal-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .full-picture p {
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        /* Criteria Not Assessed */
        .criteria-not-assessed {
            background: var(--bg-light);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .criteria-not-assessed h4 {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .criteria-not-assessed ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .criteria-not-assessed li {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
            border: 1px solid var(--border-light);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Character Counter Styles */
        .input-wrapper {
            position: relative;
        }

        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            margin-top: 6px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .char-counter.green { color: #22c55e; }
        .char-counter.yellow { color: #eab308; }
        .char-counter.red { color: #ef4444; }

        .char-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            display: none;
        }

        .char-warning.visible {
            display: block;
        }

        .input-tip {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        #question {
            min-height: 60px;
            resize: vertical;
        }

        /* Timing Notice Styles */
        .timing-notice {
            background: linear-gradient(135deg, #eff6ff 0%, #e0f2fe 100%);
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .timing-notice .pulse-icon {
            font-size: 1.2rem;
            animation: gentlePulse 2s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .timing-notice strong {
            color: #1e3a8a;
        }

        /* Amplify cooldown styles */
        .amplify-cooldown-notice {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            text-align: center;
            color: #92400e;
            font-size: 0.9rem;
            display: none;
        }

        .amplify-cooldown-notice.visible {
            display: block;
        }

        .cooldown-timer {
            font-weight: 700;
            font-size: 1.1rem;
            color: #b45309;
        }

        .btn-amplify:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        }

        .mode-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .url-field {
            display: none;
            margin-bottom: 16px;
        }

        .url-field.visible {
            display: block;
        }

        .url-field small {
            display: block;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(43, 124, 211, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: var(--bg-light);
            color: var(--text-muted);
            border: 2px solid var(--border-light);
            padding: 14px 20px;
        }

        .btn-clear:hover {
            background: var(--border-light);
            color: var(--text-dark);
        }

        .btn-amplify {
            background: linear-gradient(135deg, var(--amplify-purple) 0%, var(--amplify-purple-dark) 100%);
            color: white;
            width: 100%;
            margin-top: 24px;
            padding: 16px 28px;
        }

        .btn-amplify:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.35);
        }

        /* Second Opinion (Adjudicate) Button */
        .btn-adjudicate {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            width: 100%;
            margin-top: 12px;
            padding: 16px 28px;
        }

        .btn-adjudicate:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.35);
        }

        .btn-adjudicate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Score Comparison Panel */
        .score-comparison {
            display: none;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        .score-comparison.visible {
            display: block;
        }

        .score-comparison h3 {
            color: #047857;
            margin-bottom: 16px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid #bbf7d0;
        }

        .comparison-table th {
            background: #dcfce7;
            font-weight: 600;
            color: #166534;
        }

        .comparison-table tr:hover {
            background: rgba(134, 239, 172, 0.2);
        }

        .score-match {
            color: #16a34a;
            font-weight: 600;
        }

        .score-minor-diff {
            color: #ca8a04;
            font-weight: 600;
        }

        .score-major-diff {
            color: #dc2626;
            font-weight: 600;
        }

        .discrepancy-alert {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 14px 16px;
            color: #92400e;
            font-weight: 500;
            margin-top: 12px;
        }

        .discrepancy-alert.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consensus-note {
            background: #dcfce7;
            border-radius: 8px;
            padding: 12px 16px;
            color: #166534;
            font-weight: 500;
            margin-top: 12px;
            display: none;
        }

        .consensus-note.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Second Assessment Display */
        .second-assessment-results {
            display: none;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px solid #059669;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        .second-assessment-results.visible {
            display: block;
        }

        .second-assessment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #86efac;
        }

        .second-assessment-header h3 {
            color: #047857;
            font-size: 1.2rem;
            margin: 0;
        }

        /* Post-Assessment Options Panel */
        .post-assessment-options {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }

        @media (max-width: 700px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-card {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 20px;
        }

        .option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .option-icon {
            font-size: 1.5rem;
        }

        .option-header h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--navy);
        }

        .option-description {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 0;
            flex: 1;
        }

        .option-description strong {
            color: var(--text-dark);
        }

        .option-card .btn {
            width: 100%;
            margin-top: 16px;
        }

        /* API Key Section */
        .api-key-section {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .api-key-section summary {
            cursor: pointer;
            font-weight: 600;
            color: #92400e;
            font-size: 0.95rem;
        }

        .api-key-section p {
            margin: 12px 0;
            font-size: 0.9rem;
            color: #78350f;
        }

        .api-key-section input {
            margin-top: 8px;
        }

        .free-tier-note {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 12px;
        }

        /* Error Box */
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            font-size: 0.95rem;
        }

        .error.visible {
            display: block;
        }

        /* Results Section */
        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        /* Hero Score Display */
        .hero-section {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border-radius: 12px;
            padding: 40px 32px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top, rgba(43, 124, 211, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }

        .hero-score {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .hero-score.positive { color: var(--score-green); }
        .hero-score.negative { color: var(--score-red); }
        .hero-score.neutral { color: var(--score-yellow); }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hero-badge img {
            height: 24px;
            width: auto;
        }

        .hero-badge span {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .hero-question {
            color: white;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 8px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }

        /* Slim centered claim display */
        .claim-display {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px 24px;
            margin: 0 auto 12px auto;
            max-width: 700px;
            text-align: center;
        }

        .claim-display-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Score Bars */
        .score-bars-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .score-bar-wrapper {
            margin-bottom: 28px;
        }

        .score-bar-wrapper:last-child {
            margin-bottom: 0;
        }

        .score-bar-header {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 12px;
        }

        .score-bar-title {
            font-weight: 600;
            color: var(--navy);
            font-size: 1rem;
        }

        .score-bar-value {
            font-weight: 700;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .score-bar-container {
            position: relative;
            height: 10px;
            border-radius: 5px;
            overflow: visible;
        }

        .score-bar-gradient {
            height: 100%;
            border-radius: 5px;
        }

        .score-bar-gradient.reality {
            background: linear-gradient(90deg, 
                #ef4444 0%, 
                #f97316 20%, 
                #eab308 40%, 
                #84cc16 60%, 
                #22c55e 80%, 
                #16a34a 100%
            );
        }

        .score-bar-gradient.integrity {
            /* Dark Teal (Deceptive) â†’ Light Blue (Honest) */
            background: linear-gradient(90deg, 
                #0a1f1c 0%,      /* Nearly black teal - Deceptive */
                #003d33 15%,     /* Dark teal */
                #00574a 30%,     /* Deep teal */
                #00796b 45%,     /* Medium teal */
                #26a69a 60%,     /* Teal */
                #4dd0e1 75%,     /* Cyan */
                #81d4fa 90%,     /* Light blue */
                #b3e5fc 100%     /* Lightest blue - Honest */
            );
        }

        .score-bar-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 18px;
            background: var(--navy-dark);
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .score-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .score-bar-labels span {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Assessment Sections */
        .assessment-section {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 20px 24px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary-blue);
        }

        .assessment-section h3 {
            color: var(--navy);
            font-size: 1.05rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .assessment-section p, .assessment-section ul, .assessment-section li {
            color: var(--text-dark);
            line-height: 1.75;
            font-size: 0.95rem;
        }

        .assessment-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .assessment-section li {
            margin-bottom: 6px;
        }

        /* Section color variants */
        .section-truth { border-left-color: #10b981; }
        .section-truth h3 { color: #065f46; }
        
        .section-assessment { border-left-color: var(--primary-blue); }
        .section-assessment h3 { color: #1e40af; }
        
        .section-claim { border-left-color: #8b5cf6; }
        .section-claim h3 { color: #5b21b6; }
        
        .section-evidence { border-left-color: #f59e0b; }
        .section-evidence h3 { color: #b45309; }
        
        .section-distortion { border-left-color: #ef4444; }
        .section-distortion h3 { color: #b91c1c; }
        
        .section-confident { border-left-color: #10b981; }
        .section-confident h3 { color: #065f46; }
        
        .section-uncertain { border-left-color: #6b7280; }
        .section-uncertain h3 { color: #374151; }
        
        .section-bottom { 
            border-left-color: var(--navy); 
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        }
        .section-bottom h3 { color: var(--navy); }
        
        .section-lessons { border-left-color: #8b5cf6; }
        .section-lessons h3 { color: #5b21b6; }
        
        .section-sources { 
            border-left-color: #64748b; 
            background: #f1f5f9;
        }
        .section-sources h3 { color: #475569; }

        .section-framework { border-left-color: #0891b2; }
        .section-framework h3 { color: #0e7490; }

        .section-integrity { border-left-color: #7c3aed; }
        .section-integrity h3 { color: #5b21b6; }

        .section-methodology { border-left-color: #64748b; }
        .section-methodology h3 { color: #475569; }

        /* Chunk 2: Four-Factor Breakdown Sections */
        .section-temporal { 
            border-left-color: #0891b2; 
            background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); 
        }
        .section-temporal h3 { color: #0e7490; }

        .section-reality-breakdown { 
            border-left-color: #059669; 
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); 
        }
        .section-reality-breakdown h3 { color: #047857; }

        .section-integrity-breakdown { 
            border-left-color: #7c3aed; 
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); 
        }
        .section-integrity-breakdown h3 { color: #5b21b6; }

        /* Factor breakdown list styling */
        .section-reality-breakdown ul,
        .section-integrity-breakdown ul {
            list-style: none;
            padding-left: 0;
        }

        .section-reality-breakdown li,
        .section-integrity-breakdown li {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            border-left: 3px solid currentColor;
        }

        .section-reality-breakdown li:last-child,
        .section-integrity-breakdown li:last-child {
            font-weight: 600;
            background: rgba(255,255,255,0.9);
        }

        /* Collapsible Section Styles */
        .collapsible-section { margin-bottom: 16px; }
        .section-header-box { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; user-select: none; }
        .section-header-box:hover { filter: brightness(0.92); }
        .section-header-box h3 { margin: 0; font-size: 1rem; font-weight: 600; color: inherit; }
        .section-toggle-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.3); color: inherit; font-size: 1.2rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .section-toggle-btn:hover { background: rgba(255,255,255,0.5); }
        .section-content { display: none; padding: 16px 20px; background: var(--bg-light); border-radius: 0 0 8px 8px; margin-top: -4px; border: 1px solid var(--border-light); border-top: none; }
        .section-content.expanded { display: block; }
        .section-content p, .section-content ul, .section-content li { color: var(--text-dark); line-height: 1.75; font-size: 0.95rem; }
        .section-content ul { margin-left: 20px; margin-top: 8px; }
        .section-content li { margin-bottom: 6px; }
        .header-truth { background: #10b981; color: white; }
        .header-evidence { background: #f59e0b; color: white; }
        .header-distortion { background: #ef4444; color: white; }
        .header-confident { background: #22c55e; color: white; }
        .header-uncertain { background: #6b7280; color: white; }
        .header-bottom { background: var(--navy); color: white; }
        .header-sources { background: #64748b; color: white; }
        .header-methodology { background: #94a3b8; color: white; }
        .header-reality-breakdown { background: #059669; color: white; }
        .header-integrity-breakdown { background: #7c3aed; color: white; }
        .header-framework { background: #0891b2; color: white; }
        .header-claim { background: #8b5cf6; color: white; }
        .header-lessons { background: #8b5cf6; color: white; }
        .veritas-assessment-section { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid var(--primary-blue); border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; }
        .veritas-assessment-section h3 { color: #1e40af; margin-bottom: 12px; font-size: 1.1rem; font-weight: 600; }
        .veritas-assessment-section p { color: var(--text-dark); line-height: 1.75; font-size: 0.95rem; }

        /* Amplified Results */
        .amplified-results {
            display: none;
            margin-top: 24px;
            border: 2px solid var(--amplify-purple);
            border-radius: 12px;
            padding: 24px;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .amplified-results.visible {
            display: block;
        }

        .amplified-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
        }

        .amplified-header h3 {
            color: var(--amplify-purple-dark);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .amplified-section {
            background: white;
            border-radius: 10px;
            padding: 18px 22px;
            margin-bottom: 14px;
            border-left: 4px solid var(--amplify-purple);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .amplified-section:last-child {
            margin-bottom: 0;
        }

        .amplified-section h4 {
            color: var(--amplify-purple-dark);
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .amplified-section p, .amplified-section ul, .amplified-section li {
            color: var(--text-dark);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .amplified-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .amplified-section li {
            margin-bottom: 6px;
        }

        /* Print Styles - Preserve colors and control page breaks */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .site-header {
                position: relative !important;
                border-bottom: 2px solid var(--border-light) !important;
                margin-bottom: 20px !important;
            }

            .container {
                max-width: 100% !important;
                padding: 0 20px !important;
            }

            /* Hide input form when printing results */
            .card:has(#assessBtn) {
                display: none !important;
            }

            /* Keep hero section together */
            .hero-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%) !important;
                margin-bottom: 20px !important;
            }

            .hero-score {
                color: var(--score-green) !important;
            }

            .hero-score.positive { color: #22c55e !important; }
            .hero-score.negative { color: #ef4444 !important; }
            .hero-score.neutral { color: #eab308 !important; }

            /* Keep score bars together */
            .score-bars-container {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid var(--border-light) !important;
            }

            .score-bar-gradient.reality {
                background: linear-gradient(90deg, 
                    #ef4444 0%, 
                    #f97316 20%, 
                    #eab308 40%, 
                    #84cc16 60%, 
                    #22c55e 80%, 
                    #16a34a 100%
                ) !important;
            }

            .score-bar-gradient.integrity {
                background: linear-gradient(90deg, 
                    #0a1f1c 0%,
                    #003d33 15%,
                    #00574a 30%, 
                    #00796b 45%,
                    #26a69a 60%, 
                    #4dd0e1 75%,
                    #81d4fa 90%,
                    #b3e5fc 100%
                ) !important;
            }

            /* Keep each assessment section together */
            .assessment-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
                border: 1px solid var(--border-light) !important;
                margin-bottom: 12px !important;
            }

            /* Preserve section border colors */
            .section-truth { border-left: 4px solid #10b981 !important; }
            .section-assessment { border-left: 4px solid #2B7CD3 !important; }
            .section-claim { border-left: 4px solid #8b5cf6 !important; }
            .section-evidence { border-left: 4px solid #f59e0b !important; }
            .section-distortion { border-left: 4px solid #ef4444 !important; }
            .section-confident { border-left: 4px solid #10b981 !important; }
            .section-uncertain { border-left: 4px solid #6b7280 !important; }
            .section-bottom { 
                border-left: 4px solid var(--navy) !important; 
                background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%) !important;
            }
            .section-lessons { border-left: 4px solid #8b5cf6 !important; }
            .section-methodology { border-left: 4px solid #64748b !important; }
            .section-sources { border-left: 4px solid #64748b !important; }
            .section-framework { border-left: 4px solid #0891b2 !important; }
            .section-integrity { border-left: 4px solid #7c3aed !important; }

            /* Chunk 2: Four-Factor Breakdown print styles */
            .section-temporal { 
                border-left: 4px solid #0891b2 !important; 
                background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%) !important;
            }
            .section-reality-breakdown { 
                border-left: 4px solid #059669 !important; 
                background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
            }
            .section-integrity-breakdown { 
                border-left: 4px solid #7c3aed !important; 
                background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%) !important;
            }

            /* Hide amplify button in print */
            .btn-amplify {
                display: none !important;
            }

            /* Keep amplified sections together */
            .amplified-results {
                break-before: page !important;
                page-break-before: always !important;
                border: 2px solid var(--amplify-purple) !important;
                background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%) !important;
            }

            .amplified-section {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                border-left: 4px solid var(--amplify-purple) !important;
                box-shadow: none !important;
                margin-bottom: 10px !important;
            }

            /* Ensure text is black for readability */
            .assessment-section p,
            .assessment-section li,
            .amplified-section p,
            .amplified-section li {
                color: #1e293b !important;
            }
            .section-content { display: block !important; }
            .section-toggle-btn { display: none !important; }
            .collapsible-section, .veritas-assessment-section { break-inside: avoid !important; page-break-inside: avoid !important; }
        }

                /* ================================
           TRACK A: STRUCTURED OUTPUT STYLES
           ================================ */

        /* Claim Type Badge */
        .claim-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 12px;
        }
        .claim-type-badge.factual { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .claim-type-badge.subjective { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .claim-type-badge.value_judgment { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .claim-type-badge.prediction { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        /* Confidence Badge */
        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .confidence-badge.high { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .confidence-badge.medium { background: rgba(251, 191, 36, 0.15); color: #eab308; }
        .confidence-badge.low { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Quick Take Section */
        .quick-take-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        .quick-take-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .quick-take-header h3 {
            color: #0369a1;
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }
        .quick-take-content {
            color: var(--text-dark);
            font-size: 1.05rem;
            line-height: 1.7;
        }

        /* Holes Section */
        .holes-section {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        .holes-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #dc2626;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
        }
        .holes-list, .questions-list { list-style: none; padding: 0; margin: 0; }
        .hole-item, .question-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .hole-item { border-left: 4px solid #dc2626; }
        .question-item { border-left: 4px solid #2563eb; }
        .hole-item.hidden, .question-item.hidden { display: none; }
        .hole-header, .question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .hole-header:hover { background: #fef2f2; }
        .question-header:hover { background: #eff6ff; }
        .hole-text, .question-text {
            font-weight: 500;
            color: var(--text-dark);
            flex: 1;
            padding-right: 12px;
        }
        .hole-toggle, .question-toggle {
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .hole-toggle { background: #dc2626; }
        .question-toggle { background: #2563eb; }
        .hole-detail, .question-detail {
            display: none;
            padding: 12px 16px 16px;
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .hole-detail { border-top: 1px solid #fecaca; }
        .question-detail { border-top: 1px solid #bfdbfe; }
        .hole-detail.expanded, .question-detail.expanded { display: block; }
        .more-items-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: white;
            border: 2px dashed currentColor;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .holes-section .more-items-btn { color: #dc2626; }
        .questions-section .more-items-btn { color: #2563eb; }
        .more-items-btn.hidden { display: none; }
        .more-items-btn:hover { opacity: 0.8; }

        /* Questions Section */
        .questions-section {
            background: #eff6ff;
            border: 2px solid #bfdbfe;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        .questions-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2563eb;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
        }

        /* Five W's Section */
        .fivews-section {
            background: #ecfeff;
            border: 2px solid #a5f3fc;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        .fivews-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0891b2;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
        }
        .fivews-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        .fivew-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #0891b2;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #0891b2;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .fivew-btn:hover, .fivew-btn.active {
            background: #0891b2;
            color: white;
        }
        .fivew-content {
            background: white;
            border-radius: 8px;
            padding: 16px;
            display: none;
            color: var(--text-dark);
            line-height: 1.7;
        }
        .fivew-content.visible { display: block; }

        /* Track B Teaser */
        .track-b-teaser {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 2px dashed #c084fc;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .track-b-teaser-text { color: #7c3aed; font-size: 0.95rem; }
        .track-b-teaser-text strong { display: block; margin-bottom: 4px; }
        .track-b-btn {
            padding: 10px 20px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: not-allowed;
            opacity: 0.6;
            white-space: nowrap;
        }
        @media (max-width: 640px) {
            .track-b-teaser { flex-direction: column; text-align: center; }
            .fivews-buttons { justify-content: center; }
        }

        /* Claim Type Section in legacy markdown */
        .section-claim-type {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .section-claim-type h3 { color: #b45309; }

        /* Temporal footnote */
        .temporal-footnote {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }
        .temporal-footnote sup { color: var(--primary-blue); }


        /* Responsive */
        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .hero-score {
                font-size: 3.5rem;
            }

            .hero-question {
                font-size: 1.25rem;
            }

            .card {
                padding: 20px;
            }

            .hero-section {
                padding: 32px 20px;
            }

            .btn-row {
                flex-direction: column;
            }

            .score-bar-labels {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/veritas-logo-horizontal.png" alt="VERITAS LLC" onerror="this.style.display='none'">
                <span class="tagline">Truth through Transparency</span>
            </div>
                <div id="claimTypeBadgeContainer"></div>
            <span class="version-badge" id="versionBadge">VERACITY ENGINEâ„¢ v4.3 â€” Track A</span>
        </div>
    </header>

    <div class="container">
        <!-- Input Card -->
        <div class="card">
            <div class="error" id="errorBox"></div>

            <!-- Track A/B Toggle -->
            <div class="track-toggle">
                <button type="button" class="track-tab active" id="trackATab" onclick="setTrack('a')">
                    ðŸ“Š Track A â€” Factual Claims
                </button>
                <button type="button" class="track-tab track-b" id="trackBTab" onclick="setTrack('b')">
                    ðŸŽ¯ Track B â€” Subjective Claims
                </button>
            </div>

            <div class="track-description" id="trackDescription">
                <strong>Track A</strong> assesses factual claims using evidence quality, source reliability, and logical coherence. Best for questions with objectively verifiable answers.
            </div>

            <!-- Track A Panel -->
            <div class="track-a-panel visible" id="trackAPanel">
                <div class="mode-toggle">
                    <button type="button" class="mode-tab active" id="questionModeTab" onclick="setMode('question')">
                        â“ Research Question
                    </button>
                    <button type="button" class="mode-tab" id="articleModeTab" onclick="setMode('article')">
                        ðŸ“° Assess Article
                    </button>
                </div>

                <div class="mode-hint" id="modeHint">
                    Enter a claim or question and VERITAS will search for evidence and provide an assessment.
                </div>

                <div class="url-field" id="urlField">
                    <label for="articleUrl">Article URL</label>
                    <input type="text" id="articleUrl" placeholder="https://example.com/article...">
                    <small>Providing the source URL helps VERITAS verify the article's context and credibility</small>
                </div>

                <div class="form-group">
                    <label for="question" id="questionLabel">Question or Claim to Assess</label>
                    <div class="input-wrapper">
                        <textarea id="question" maxlength="600" placeholder="Enter ONE specific claim to assess (e.g., 'Climate change is primarily caused by human activity')" oninput="updateCharCounter()"></textarea>
                        <div class="char-counter green" id="charCounter">0 / 280 characters</div>
                        <div class="char-warning" id="charWarning">âš ï¸ That's getting long! For the best assessment, try to focus on ONE specific claim. Can you simplify?</div>
                    </div>
                    <p class="input-tip">ðŸ’¡ <strong>Tip:</strong> One claim at a time works best. Keep it under 280 characters for optimal results.</p>
                </div>

                <div class="form-group">
                    <label for="articleText">Article Text (Optional)</label>
                    <textarea id="articleText" placeholder="Paste article text here for analysis, or leave blank to assess just the question above..."></textarea>
                </div>
            </div>

            <!-- Track B Panel -->
            <div class="track-b-panel" id="trackBPanel">
                <div class="form-group">
                    <label for="trackBQuestion">Subjective Claim to Assess</label>
                    <div class="input-wrapper">
                        <textarea id="trackBQuestion" maxlength="600" placeholder="Enter a subjective claim (e.g., 'Trump is qualified to be president', 'The Green New Deal is good policy')" oninput="updateTrackBCharCounter()"></textarea>
                        <div class="char-counter green" id="trackBCharCounter">0 / 280 characters</div>
                    </div>
                </div>

                <!-- Context Questions (5 W's) -->
                <div class="claim-type-confirmation">
                    <h4>Help us understand your claim better (optional):</h4>
                    <div class="five-ws-inputs">
                        <div class="ws-input-group">
                            <label>ðŸ‘¤ <strong>Who</strong> is involved in this claim?</label>
                            <input type="text" id="wsWho" placeholder="e.g., A person, company, organization...">
                        </div>
                        <div class="ws-input-group">
                            <label>ðŸ“¦ <strong>What</strong> product, service, or action is being examined?</label>
                            <input type="text" id="wsWhat" placeholder="e.g., A policy, product, decision...">
                        </div>
                        <div class="ws-input-group">
                            <label>ðŸ• <strong>When</strong> did/will this happen?</label>
                            <input type="text" id="wsWhen" placeholder="e.g., Currently, in 2024, historically...">
                        </div>
                        <div class="ws-input-group">
                            <label>ðŸ“ <strong>Where</strong> is this relevant?</label>
                            <input type="text" id="wsWhere" placeholder="e.g., USA, locally, globally...">
                        </div>
                        <div class="ws-input-group">
                            <label>â“ <strong>How</strong> is this affecting people today?</label>
                            <input type="text" id="wsHow" placeholder="e.g., Economic impact, social change...">
                        </div>
                    </div>
                </div>

                <!-- Criteria Selection -->
                <div class="criteria-selection" id="criteriaSelection">
                    <div class="criteria-header">
                        <h4>Select up to 3 criteria to assess:</h4>
                        <span class="criteria-count" id="criteriaCount">0 / 3 selected</span>
                    </div>
                    <div class="criteria-list" id="criteriaList">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="custom-criteria-section">
                        <label>Add your own criterion:</label>
                        <div class="custom-criteria-row">
                            <input type="text" id="customCriteriaInput" placeholder="e.g., 'Foreign policy experience'">
                            <button class="btn-add-criteria" onclick="addCustomCriteria()">+ Add</button>
                        </div>
                        <div class="custom-criteria-error" id="customCriteriaError"></div>
                    </div>
                </div>
            </div>

            <details class="api-key-section">
                <summary>Use Your Own API Key (Optional)</summary>
                <p>Get unlimited assessments by using your own Anthropic API key. Without a key, you get 5 free assessments per day.</p>
                <input type="text" id="apiKey" placeholder="sk-ant-...">
            </details>

            <div class="timing-notice">
                <span class="pulse-icon">â±ï¸</span>
                <span><strong>Please be patient:</strong> Thorough assessments take 30-40 seconds. VERITAS searches multiple sources and cross-references evidence to give you an accurate analysis.</span>
            </div>

            <div class="btn-row" id="trackAButtons">
                <button class="btn btn-clear" onclick="clearForm()">ðŸ—‘ï¸ Clear</button>
                <button class="btn btn-primary" id="assessBtn" onclick="runAssessment()">Assess with VERITAS</button>
            </div>
            <div class="btn-row" id="trackBButtons" style="display:none;">
                <button class="btn btn-clear" onclick="clearForm()">ðŸ—‘ï¸ Clear</button>
                <button class="btn btn-track-b" id="assessBtnTrackB" onclick="runTrackBAssessment()">ðŸŽ¯ Assess Selected Criteria</button>
            </div>
            <p class="free-tier-note">5 free assessments per day â€¢ Powered by Claude with web search</p>
        </div>

        <!-- Results Section -->
        <div class="results" id="results">
            <!-- Hero Score Display -->
            <div class="hero-section">
                <div class="hero-badge">
                    <img src="/veritas-logo-horizontal.png" alt="VERITAS" style="height: 20px; filter: brightness(0) invert(1);" onerror="this.parentElement.innerHTML='<span>VERITAS</span>'">
                </div>
                <div class="hero-score positive" id="heroScore">+8</div>
                <div class="claim-display" id="claimDisplay">
                    <span class="claim-display-text" id="heroQuestion">Do dogs dream in their sleep?</span>
                </div>
                <div class="hero-subtitle">Reality Score: Is the claim TRUE or FALSE?</div>
            </div>

            <!-- Score Bars -->
            <div class="score-bars-container">
                <div class="score-bar-wrapper">
                    <div class="score-bar-header">
                        <span class="score-bar-title">Reality Score:</span>
                        <span class="score-bar-value" id="realityScoreDisplay">+8</span>
                        <span class="confidence-badge" id="confidenceBadge" style="display:none;">High</span>
                    </div>
                    <div class="score-bar-container">
                        <div class="score-bar-gradient reality"></div>
                        <div class="score-bar-marker" id="realityMarker" style="left: 90%;"></div>
                    </div>
                    <div class="score-bar-labels">
                        <span>-10<br>FALSE</span>
                        <span>-5</span>
                        <span>0<br>UNCERTAIN</span>
                        <span>+5</span>
                        <span>+10<br>TRUE</span>
                    </div>
                </div>

                <div class="score-bar-wrapper">
                    <div class="score-bar-header">
                        <span class="score-bar-title">Integrity Score:</span>
                        <span class="score-bar-value" id="integrityScoreDisplay">+0.90</span>
                    </div>
                    <div class="score-bar-container">
                        <div class="score-bar-gradient integrity"></div>
                        <div class="score-bar-marker" id="integrityMarker" style="left: 95%;"></div>
                    </div>
                    <div class="score-bar-labels">
                        <span>-1.0<br>Deceptive</span>
                        <span>-0.5<br>Dishonest</span>
                        <span>0<br>Neutral</span>
                        <span>+0.5<br>Good</span>
                        <span>+1.0<br>Honest</span>
                    </div>
                </div>
            </div>

                        <!-- Quick Take Section (Track A) -->
            <div class="quick-take-section" id="quickTakeSection" style="display: none;">
                <div class="quick-take-header">
                    <span style="font-size: 1.2rem;">âš¡</span>
                    <h3>Quick Take</h3>
                </div>
                <div class="quick-take-content" id="quickTakeContent"></div>
            </div>

            <!-- Holes Section (Track A) -->
            <div class="holes-section" id="holesSection" style="display: none;">
                <div class="holes-header">
                    <h3><span>âš ï¸</span> Holes in This Answer</h3>
                </div>
                <ul class="holes-list" id="holesList"></ul>
                <button class="more-items-btn hidden" id="moreHolesBtn" onclick="showMoreHoles()">+3 More Gaps</button>
            </div>

            <!-- Questions Section (Track A) -->
            <div class="questions-section" id="questionsSection" style="display: none;">
                <div class="questions-header">
                    <h3><span>ðŸ”</span> Questions You Should Also Ask</h3>
                </div>
                <ul class="questions-list" id="questionsList"></ul>
                <button class="more-items-btn hidden" id="moreQuestionsBtn" onclick="showMoreQuestions()">+3 More Questions</button>
            </div>

            <!-- Five W's Section (Track A) -->
            <div class="fivews-section" id="fivewsSection" style="display: none;">
                <div class="fivews-header">
                    <span style="font-size: 1.2rem;">ðŸ“‹</span>
                    <h3>Context (5 W's)</h3>
                </div>
                <div class="fivews-buttons">
                    <button class="fivew-btn" onclick="toggleFiveW('who')">Who</button>
                    <button class="fivew-btn" onclick="toggleFiveW('what')">What</button>
                    <button class="fivew-btn" onclick="toggleFiveW('where')">Where</button>
                    <button class="fivew-btn" onclick="toggleFiveW('when')">When</button>
                    <button class="fivew-btn" onclick="toggleFiveW('how')">How</button>
                </div>
                <div class="fivew-content" id="fivewContent"></div>
            </div>

            <!-- Track B Teaser -->
            <div class="track-b-teaser" id="trackBTeaser" style="display: none;">
                <div class="track-b-teaser-text">
                    <strong>Want deeper analysis?</strong>
                    Track B lets you define specific criteria for subjective claims like "qualified" or "effective".
                </div>
                <button class="track-b-btn" disabled>Coming Soon</button>
            </div>


            <!-- Assessment Content -->
            <div class="card">
                <div id="formattedAssessment"></div>
                
                <!-- Temporal Verification Footnote -->
                <div class="temporal-footnote" id="temporalFootnote" style="display: none;">
                    <sup>*</sup> Temporal verification completed â€” claim currency confirmed as of assessment date.
                </div>
            </div>

            <!-- Post-Assessment Options Panel -->
            <div class="post-assessment-options" id="postAssessmentOptions" style="display: none;">
                <h3 style="color: var(--navy); margin-bottom: 16px; font-size: 1.1rem;">ðŸ”¬ Want to Go Deeper?</h3>
                
                <div class="options-grid">
                    <!-- Amplify Option -->
                    <div class="option-card">
                        <div class="option-header">
                            <span class="option-icon">ðŸ”</span>
                            <h4>Amplify</h4>
                        </div>
                        <p class="option-description">
                            Stress-test the assessment â€” challenge assumptions, explore 
                            alternative interpretations, find blind spots. <strong>Best for:</strong> 
                            Understanding where the analysis might be vulnerable.
                        </p>
                        <button class="btn btn-amplify" id="amplifyBtn" onclick="runAmplify()" disabled>
                            ðŸ” Amplify â€” Explore Vulnerabilities
                        </button>
                    </div>

                    <!-- Verify Option -->
                    <div class="option-card">
                        <div class="option-header">
                            <span class="option-icon">âœ“</span>
                            <h4>Verify</h4>
                        </div>
                        <p class="option-description">
                            Get an independent second evaluation using identical methodology â€” 
                            fresh eyes, no knowledge of the first assessment. Compare scores 
                            to confirm reliability. <strong>Best for:</strong> Validating scores before acting on them.
                        </p>
                        <button class="btn btn-adjudicate" id="adjudicateBtn" onclick="runVerify()" disabled>
                            âœ“ Verify â€” Independent Confirmation
                        </button>
                    </div>
                </div>

                <div class="amplify-cooldown-notice" id="amplifyCooldown">
                    <span class="pulse-icon">â³</span> Deep analysis requires preparation. Options available in <span class="cooldown-timer" id="cooldownTimer">60</span> seconds...
                </div>
            </div>

            <!-- Score Comparison Panel -->
            <div class="score-comparison" id="scoreComparison">
                <h3>âœ“ Verification Results â€” Two Independent Assessments</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Assessor</th>
                            <th>Reality Score</th>
                            <th>Integrity Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Initial</strong></td>
                            <td id="primaryReality">â€”</td>
                            <td id="primaryIntegrity">â€”</td>
                        </tr>
                        <tr>
                            <td><strong>Verification</strong></td>
                            <td id="secondaryReality">â€”</td>
                            <td id="secondaryIntegrity">â€”</td>
                        </tr>
                        <tr style="background: #f0fdf4;">
                            <td><strong>Difference</strong></td>
                            <td id="diffReality">â€”</td>
                            <td id="diffIntegrity">â€”</td>
                        </tr>
                    </tbody>
                </table>
                <div class="consensus-note" id="consensusNote">
                    <span>âœ…</span> <span id="consensusText">Strong consensus between assessors.</span>
                </div>
                <div class="discrepancy-alert" id="discrepancyAlert">
                    <span>âš ï¸</span> <span id="discrepancyText">Significant discrepancy detected â€” review both assessments carefully.</span>
                </div>
            </div>

            <!-- Verification Results -->
            <div class="second-assessment-results" id="secondAssessmentResults">
                <div class="second-assessment-header">
                    <span style="font-size: 1.5rem;">âœ“</span>
                    <h3>Verification Assessment â€” Independent Evaluation</h3>
                </div>
                <div id="formattedSecondAssessment"></div>
            </div>

            <!-- Amplified Results -->
            <div class="amplified-results" id="amplifiedResults">
                <div class="amplified-header">
                    <span style="font-size: 1.5rem;">ðŸ”</span>
                    <h3>Amplified Analysis â€” Epistemic Deep Dive</h3>
                </div>
                <div id="formattedAmplified"></div>
            </div>
        </div>
    </div>

    <script>
        var lastAssessment = null;
        var currentMode = 'question';
        var currentQuestion = '';
        var amplifyCooldownTimer = null;
        var amplifyCooldownSeconds = 0;

        // ================================
        // TRACK A: STATE VARIABLES
        // ================================
        var currentStructured = null;
        var holesVisiblePriority = 1;
        var questionsVisiblePriority = 1;
        var fiveWsData = null;

        // ================================
        // TRACK B: STATE VARIABLES
        // ================================
        var currentTrack = 'a';
        var selectedClaimType = 'generic';
        var selectedCriteria = [];
        var customCriteriaList = [];
        var MAX_CRITERIA = 3;

        // Track B Criteria Definitions
        var CRITERIA_SETS = {
            qualification: {
                label: 'Person Qualification',
                criteria: [
                    { id: 'legal', label: 'Legal Eligibility', description: 'Does the person meet legal/constitutional requirements for the role?' },
                    { id: 'experience', label: 'Experience & Credentials', description: 'What relevant experience, education, or credentials does the person have?' },
                    { id: 'record', label: 'Historical Record', description: 'What is their track record in similar or related roles?' },
                    { id: 'alignment', label: 'Value Alignment', description: 'How do their stated values align with the role\'s requirements?' },
                    { id: 'controversies', label: 'Controversies & Concerns', description: 'What documented concerns, controversies, or red flags exist?' }
                ]
            },
            policy: {
                label: 'Policy Effectiveness',
                criteria: [
                    { id: 'goals', label: 'Stated Goals Clarity', description: 'Are the policy\'s goals clearly defined and measurable?' },
                    { id: 'outcomes', label: 'Measurable Outcomes', description: 'What evidence exists about the policy\'s actual outcomes?' },
                    { id: 'costbenefit', label: 'Cost/Benefit Analysis', description: 'How do the costs compare to the benefits?' },
                    { id: 'alternatives', label: 'Comparison to Alternatives', description: 'How does this policy compare to alternative approaches?' },
                    { id: 'implementation', label: 'Implementation Challenges', description: 'What practical challenges affect implementation?' }
                ]
            },
            product: {
                label: 'Product/Service Quality',
                criteria: [
                    { id: 'audience', label: 'Who benefits from this product or service?', description: 'For whom is this product/service appropriate?' },
                    { id: 'measure', label: 'Success Criteria', description: 'By what measure is success/quality defined?' },
                    { id: 'comparison', label: 'Comparison to Alternatives', description: 'How does it compare to alternatives?' },
                    { id: 'timeframe', label: 'Timeframe Considerations', description: 'What are short-term vs long-term implications?' },
                    { id: 'credibility', label: 'Source Credibility', description: 'What conflicts of interest or biases exist in claims about it?' }
                ]
            },
            prediction: {
                label: 'Prediction/Forecast',
                criteria: [
                    { id: 'trackrecord', label: 'Predictor Track Record', description: 'What is the predictor\'s history of accuracy?' },
                    { id: 'transparency', label: 'Model Transparency', description: 'Is the reasoning/model behind the prediction transparent?' },
                    { id: 'baserates', label: 'Base Rates Acknowledged', description: 'Are historical base rates considered?' },
                    { id: 'uncertainty', label: 'Uncertainty Quantified', description: 'Is uncertainty appropriately acknowledged and quantified?' },
                    { id: 'falsifiability', label: 'Falsifiability Defined', description: 'What would prove the prediction wrong?' }
                ]
            },
            generic: {
                label: 'General Assessment',
                criteria: [
                    { id: 'evidence', label: 'Evidence Quality', description: 'What evidence supports or refutes this claim?' },
                    { id: 'expertise', label: 'Source Expertise', description: 'Do the sources have relevant expertise?' },
                    { id: 'audience', label: 'Who benefits?', description: 'Who gains or loses if this claim is accepted?' },
                    { id: 'alternatives', label: 'Alternative Perspectives', description: 'What competing viewpoints exist?' },
                    { id: 'outcomes', label: 'Measurable Outcomes', description: 'What concrete outcomes can be measured?' },
                    { id: 'timeframe', label: 'Timeframe Considerations', description: 'What are short-term vs long-term implications?' }
                ]
            }
        };

        // ================================
        // TRACK SWITCHING
        // ================================
        function setTrack(track) {
            currentTrack = track;
            var trackATab = document.getElementById('trackATab');
            var trackBTab = document.getElementById('trackBTab');
            var trackAPanel = document.getElementById('trackAPanel');
            var trackBPanel = document.getElementById('trackBPanel');
            var trackAButtons = document.getElementById('trackAButtons');
            var trackBButtons = document.getElementById('trackBButtons');
            var trackDescription = document.getElementById('trackDescription');
            var versionBadge = document.getElementById('versionBadge');

            if (track === 'b') {
                trackATab.classList.remove('active');
                trackBTab.classList.add('active');
                trackAPanel.classList.remove('visible');
                trackBPanel.classList.add('visible');
                trackAButtons.style.display = 'none';
                trackBButtons.style.display = 'flex';
                trackDescription.className = 'track-description track-b';
                trackDescription.innerHTML = '<strong>Track B</strong> assesses subjective claims through criteria YOU select. Pick what matters to you â€” VERITAS evaluates each criterion independently without forcing a single "right answer."';
                versionBadge.textContent = 'VERACITY ENGINEâ„¢ v4.3 â€” Track B';
                renderCriteriaList();
            } else {
                trackBTab.classList.remove('active');
                trackATab.classList.add('active');
                trackBPanel.classList.remove('visible');
                trackAPanel.classList.add('visible');
                trackBButtons.style.display = 'none';
                trackAButtons.style.display = 'flex';
                trackDescription.className = 'track-description';
                trackDescription.innerHTML = '<strong>Track A</strong> assesses factual claims using evidence quality, source reliability, and logical coherence. Best for questions with objectively verifiable answers.';
                versionBadge.textContent = 'VERACITY ENGINEâ„¢ v4.3 â€” Track A';
            }
        }

        // ================================
        // TRACK B: CLAIM TYPE SELECTION
        // ================================
        function selectClaimType(type) {
            selectedClaimType = type;
            selectedCriteria = [];
            customCriteriaList = [];
            
            document.querySelectorAll('.claim-type-option').forEach(function(el) {
                el.classList.remove('selected');
            });
            document.querySelector('.claim-type-option[data-type="' + type + '"]').classList.add('selected');
            
            renderCriteriaList();
            updateCriteriaCount();
        }

        // ================================
        // TRACK B: CRITERIA SELECTION
        // ================================
        function renderCriteriaList() {
            var list = document.getElementById('criteriaList');
            var criteriaSet = CRITERIA_SETS[selectedClaimType];
            list.innerHTML = '';

            criteriaSet.criteria.forEach(function(c) {
                var isSelected = selectedCriteria.includes(c.id);
                var isDisabled = !isSelected && selectedCriteria.length + customCriteriaList.length >= MAX_CRITERIA;
                
                var div = document.createElement('div');
                div.className = 'criteria-item' + (isSelected ? ' selected' : '') + (isDisabled ? ' disabled' : '');
                div.setAttribute('data-id', c.id);
                div.onclick = function() { toggleCriteria(c.id); };
                
                div.innerHTML = '<div class="criteria-checkbox">' + (isSelected ? 'âœ“' : '') + '</div>' +
                    '<div class="criteria-content"><strong>' + c.label + '</strong><small>' + c.description + '</small></div>';
                
                list.appendChild(div);
            });

            // Add custom criteria to list
            customCriteriaList.forEach(function(c, idx) {
                var div = document.createElement('div');
                div.className = 'criteria-item selected';
                div.innerHTML = '<div class="criteria-checkbox">âœ“</div>' +
                    '<div class="criteria-content"><strong>Custom: ' + escapeHtml(c) + '</strong><small>User-defined criterion</small></div>';
                div.onclick = function() { removeCustomCriteria(idx); };
                list.appendChild(div);
            });
        }

        function toggleCriteria(id) {
            var idx = selectedCriteria.indexOf(id);
            if (idx > -1) {
                selectedCriteria.splice(idx, 1);
            } else if (selectedCriteria.length + customCriteriaList.length < MAX_CRITERIA) {
                selectedCriteria.push(id);
            }
            renderCriteriaList();
            updateCriteriaCount();
        }

        function updateCriteriaCount() {
            var total = selectedCriteria.length + customCriteriaList.length;
            var countEl = document.getElementById('criteriaCount');
            countEl.textContent = total + ' / ' + MAX_CRITERIA + ' selected';
            countEl.className = 'criteria-count' + (total >= MAX_CRITERIA ? ' full' : '');
            
            // Enable/disable assess button
            var btn = document.getElementById('assessBtnTrackB');
            btn.disabled = total === 0;
        }

        function addCustomCriteria() {
            var input = document.getElementById('customCriteriaInput');
            var errorEl = document.getElementById('customCriteriaError');
            var value = input.value.trim();
            
            if (!value) return;
            
            if (selectedCriteria.length + customCriteriaList.length >= MAX_CRITERIA) {
                errorEl.textContent = 'You\'ve already selected ' + MAX_CRITERIA + ' criteria. Remove one first.';
                errorEl.classList.add('visible');
                return;
            }
            
            // Validate for gibberish
            var vowelCount = (value.toLowerCase().match(/[aeiou]/g) || []).length;
            var letterCount = (value.toLowerCase().match(/[a-z]/g) || []).length;
            
            if (letterCount > 5 && vowelCount / letterCount < 0.15) {
                errorEl.textContent = "ðŸ¤¨ What was that? Did you switch languages on me or what? Try something I can actually assess â€” like 'crisis management' or 'bipartisan cooperation.'";
                errorEl.classList.add('visible');
                return;
            }
            
            errorEl.classList.remove('visible');
            customCriteriaList.push(value);
            input.value = '';
            renderCriteriaList();
            updateCriteriaCount();
        }

        function removeCustomCriteria(idx) {
            customCriteriaList.splice(idx, 1);
            renderCriteriaList();
            updateCriteriaCount();
        }

        function updateTrackBCharCounter() {
            var textarea = document.getElementById('trackBQuestion');
            var counter = document.getElementById('trackBCharCounter');
            var len = textarea.value.length;
            
            counter.textContent = len + ' / 280 characters';
            counter.className = 'char-counter ' + (len <= 200 ? 'green' : (len <= 280 ? 'yellow' : 'red'));
        }

        // ================================
        // TRACK B: RUN ASSESSMENT
        // ================================
        function runTrackBAssessment() {
            var question = document.getElementById('trackBQuestion').value.trim();
            var userApiKey = document.getElementById('apiKey').value.trim();
            var btn = document.getElementById('assessBtnTrackB');
            var errorBox = document.getElementById('errorBox');
            var results = document.getElementById('results');
            
            if (!question) {
                errorBox.textContent = 'Please enter a claim to assess.';
                errorBox.classList.add('visible');
                return;
            }
            
            if (selectedCriteria.length + customCriteriaList.length === 0) {
                errorBox.textContent = 'Please select at least one criterion to assess.';
                errorBox.classList.add('visible');
                return;
            }
            
            errorBox.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'ðŸŽ¯ Assessing...';
            currentQuestion = question;
            
            // Gather 5 W's context
            var fiveWsContext = {
                who: document.getElementById('wsWho') ? document.getElementById('wsWho').value.trim() : '',
                what: document.getElementById('wsWhat') ? document.getElementById('wsWhat').value.trim() : '',
                when: document.getElementById('wsWhen') ? document.getElementById('wsWhen').value.trim() : '',
                where: document.getElementById('wsWhere') ? document.getElementById('wsWhere').value.trim() : '',
                how: document.getElementById('wsHow') ? document.getElementById('wsHow').value.trim() : ''
            };
            
            var requestBody = {
                question: question,
                track: 'b',
                claimType: selectedClaimType,
                criteria: selectedCriteria,
                customCriteria: customCriteriaList,
                fiveWsContext: fiveWsContext,
                userApiKey: userApiKey
            };
            
            fetch('/api/assess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || 'Assessment failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                renderTrackBResults(data);
                results.classList.add('visible');
                results.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                errorBox.textContent = 'Error: ' + err.message;
                errorBox.classList.add('visible');
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'ðŸŽ¯ Assess Selected Criteria';
            });
        }

        // ================================
        // TRACK B: RENDER RESULTS
        // ================================
        function renderTrackBResults(data) {
            var structured = data.structured;
            var trackB = structured && structured.trackB;
            
            // Update hero section for Track B
            document.getElementById('heroQuestion').textContent = currentQuestion;
            document.getElementById('heroScore').textContent = 'ðŸŽ¯';
            document.getElementById('heroScore').className = 'hero-score neutral';
            document.querySelector('.hero-subtitle').textContent = 'Track B: Criteria-Specific Assessment';
            
            // Hide Track A score bars for Track B
            document.querySelector('.score-bars-container').style.display = 'none';
            
            // Reset Track A sections
            resetTrackASections();
            
            // Create Track B results container if it doesn't exist
            var trackBResultsContainer = document.getElementById('trackBResultsContainer');
            if (!trackBResultsContainer) {
                trackBResultsContainer = document.createElement('div');
                trackBResultsContainer.id = 'trackBResultsContainer';
                trackBResultsContainer.className = 'card trackb-results visible';
                document.querySelector('.score-bars-container').after(trackBResultsContainer);
            } else {
                trackBResultsContainer.classList.add('visible');
            }
            
            var html = '<div class="trackb-header"><h3>ðŸŽ¯ Track B Assessment</h3><p>' + CRITERIA_SETS[selectedClaimType].label + '</p></div>';
            
            // Render criteria results
            if (trackB && trackB.criteriaAssessed) {
                var scores = trackB.criteriaAssessed.map(function(c) { return c.score; });
                var maxScore = Math.max.apply(null, scores);
                var minScore = Math.min.apply(null, scores);
                var spread = maxScore - minScore;
                
                // Divergence warning
                if (spread >= 4) {
                    html += '<div class="divergence-warning visible">' +
                        '<span class="icon">âš ï¸</span>' +
                        '<div><h4>Divergence Notice</h4>' +
                        '<p>These criteria tell different stories (spread: ' + spread + ' points). No single score captures this complexity.</p></div></div>';
                }
                
                // Criteria bars
                trackB.criteriaAssessed.forEach(function(c) {
                    var scoreClass = c.score >= 3 ? 'positive' : (c.score <= -3 ? 'negative' : 'neutral');
                    var barWidth = Math.abs(c.score) * 5; // 5% per point
                    var barDirection = c.score >= 0 ? 'positive' : 'negative';
                    
                    html += '<div class="criteria-result">' +
                        '<div class="criteria-result-header">' +
                        '<span class="criteria-result-label">' + c.label + '</span>' +
                        '<span class="criteria-result-score ' + scoreClass + '">' + (c.score >= 0 ? '+' : '') + c.score + '</span>' +
                        '</div>' +
                        '<div class="centered-bar-container">' +
                        '<div class="centered-bar-zero"></div>' +
                        '<div class="centered-bar-fill ' + barDirection + '" style="width: ' + barWidth + '%;"></div>' +
                        '</div>' +
                        '<div class="centered-bar-labels"><span>-10</span><span>0</span><span>+10</span></div>' +
                        '<div class="criteria-result-summary">' + escapeHtml(c.summary) +
                        '<span class="criteria-result-confidence ' + c.confidence.toLowerCase() + '">' + c.confidence + '</span></div>' +
                        '</div>';
                });
                
                // Full Picture
                if (trackB.fullPicture) {
                    html += '<div class="full-picture"><h4>ðŸ“Š Full Picture</h4><p>' + escapeHtml(trackB.fullPicture) + '</p></div>';
                }
                
                // Criteria not assessed
                if (trackB.criteriaNotAssessed && trackB.criteriaNotAssessed.length > 0) {
                    html += '<div class="criteria-not-assessed"><h4>Criteria Not Assessed:</h4><ul>';
                    trackB.criteriaNotAssessed.forEach(function(c) {
                        html += '<li>' + escapeHtml(c) + '</li>';
                    });
                    html += '</ul></div>';
                }
                
                // Add Plug the Holes button
                html += '<div class="trackb-amplify-section">';
                html += '<button class="btn btn-amplify" id="trackBAmplifyBtn" onclick="runTrackBAmplify()">';
                html += 'ðŸ” Plug the Holes â€” Fill in What\'s Missing</button>';
                html += '</div>';
            }
            
            trackBResultsContainer.innerHTML = html;
            
            // Still show full markdown assessment below
            document.getElementById('formattedAssessment').innerHTML = formatAssessment(data.assessment);
        }

        // ================================
        // TRACK A: STRUCTURED OUTPUT RENDERING  
        // ================================
        function renderStructuredOutput(structured) {
            if (!structured) return;
            currentStructured = structured;

            if (structured.quickTake) {
                document.getElementById('quickTakeContent').textContent = structured.quickTake;
                document.getElementById('quickTakeSection').style.display = 'block';
            }
            if (structured.holes && structured.holes.length > 0) {
                renderHoles(structured.holes);
                document.getElementById('holesSection').style.display = 'block';
            }
            if (structured.questions && structured.questions.length > 0) {
                renderQuestions(structured.questions);
                document.getElementById('questionsSection').style.display = 'block';
            }
            if (structured.fiveWs) {
                fiveWsData = structured.fiveWs;
                document.getElementById('fivewsSection').style.display = 'block';
            }
            if (structured.claimType && structured.claimType.toLowerCase() === 'subjective') {
                document.getElementById('trackBTeaser').style.display = 'flex';
            }
            // Show temporal footnote if temporal verification was done
            if (structured.temporalVerification) {
                document.getElementById('temporalFootnote').style.display = 'block';
            }
        }

        function renderHoles(holes) {
            var list = document.getElementById('holesList');
            list.innerHTML = '';
            holesVisiblePriority = 1;
            holes.forEach(function(hole, index) {
                var priority = hole.priority || 1;
                var li = document.createElement('li');
                li.className = 'hole-item' + (priority > 1 ? ' hidden' : '');
                li.setAttribute('data-priority', priority);
                li.innerHTML = '<div class="hole-header" onclick="toggleHoleDetail(' + index + ')"><span class="hole-text">' + escapeHtml(hole.text) + '</span><button class="hole-toggle" id="holeToggle' + index + '">+</button></div><div class="hole-detail" id="holeDetail' + index + '">' + escapeHtml(hole.detail || '') + '</div>';
                list.appendChild(li);
            });
            updateMoreHolesButton(holes);
        }

        function toggleHoleDetail(index) {
            var detail = document.getElementById('holeDetail' + index);
            var toggle = document.getElementById('holeToggle' + index);
            detail.classList.toggle('expanded');
            toggle.textContent = detail.classList.contains('expanded') ? 'âˆ’' : '+';
        }

        function showMoreHoles() {
            holesVisiblePriority++;
            document.querySelectorAll('#holesList .hole-item').forEach(function(item) {
                if (parseInt(item.getAttribute('data-priority')) <= holesVisiblePriority) {
                    item.classList.remove('hidden');
                }
            });
            updateMoreHolesButton(currentStructured.holes);
        }

        function updateMoreHolesButton(holes) {
            var btn = document.getElementById('moreHolesBtn');
            var hasMore = holes.some(function(h) { return (h.priority || 1) > holesVisiblePriority; });
            btn.classList.toggle('hidden', !hasMore);
        }

        function renderQuestions(questions) {
            var list = document.getElementById('questionsList');
            list.innerHTML = '';
            questionsVisiblePriority = 1;
            questions.forEach(function(q, index) {
                var priority = q.priority || 1;
                var li = document.createElement('li');
                li.className = 'question-item' + (priority > 1 ? ' hidden' : '');
                li.setAttribute('data-priority', priority);
                li.innerHTML = '<div class="question-header" onclick="toggleQuestionDetail(' + index + ')"><span class="question-text">' + escapeHtml(q.text) + '</span><button class="question-toggle" id="questionToggle' + index + '">+</button></div><div class="question-detail" id="questionDetail' + index + '">' + escapeHtml(q.detail || '') + '</div>';
                list.appendChild(li);
            });
            updateMoreQuestionsButton(questions);
        }

        function toggleQuestionDetail(index) {
            var detail = document.getElementById('questionDetail' + index);
            var toggle = document.getElementById('questionToggle' + index);
            detail.classList.toggle('expanded');
            toggle.textContent = detail.classList.contains('expanded') ? 'âˆ’' : '+';
        }

        function showMoreQuestions() {
            questionsVisiblePriority++;
            document.querySelectorAll('#questionsList .question-item').forEach(function(item) {
                if (parseInt(item.getAttribute('data-priority')) <= questionsVisiblePriority) {
                    item.classList.remove('hidden');
                }
            });
            updateMoreQuestionsButton(currentStructured.questions);
        }

        function updateMoreQuestionsButton(questions) {
            var btn = document.getElementById('moreQuestionsBtn');
            var hasMore = questions.some(function(q) { return (q.priority || 1) > questionsVisiblePriority; });
            btn.classList.toggle('hidden', !hasMore);
        }

        function toggleFiveW(which) {
            if (!fiveWsData) return;
            var content = document.getElementById('fivewContent');
            var buttons = document.querySelectorAll('.fivew-btn');
            buttons.forEach(function(btn) {
                if (btn.textContent.toLowerCase() === which) {
                    btn.classList.toggle('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            var activeBtn = document.querySelector('.fivew-btn.active');
            if (activeBtn && fiveWsData[which]) {
                content.textContent = fiveWsData[which];
                content.classList.add('visible');
            } else {
                content.classList.remove('visible');
            }
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function resetTrackASections() {
            document.getElementById('quickTakeSection').style.display = 'none';
            document.getElementById('holesSection').style.display = 'none';
            document.getElementById('questionsSection').style.display = 'none';
            document.getElementById('fivewsSection').style.display = 'none';
            document.getElementById('trackBTeaser').style.display = 'none';
            document.getElementById('claimTypeBadgeContainer').innerHTML = '';
            document.getElementById('confidenceBadge').style.display = 'none';
            document.getElementById('temporalFootnote').style.display = 'none';
            currentStructured = null;
            holesVisiblePriority = 1;
            questionsVisiblePriority = 1;
            fiveWsData = null;
        }

        function updateClaimTypeAndConfidence(claimType, confidence) {
            var badgeContainer = document.getElementById('claimTypeBadgeContainer');
            if (claimType) {
                var labels = { 'factual': 'ðŸ“Š Factual Claim', 'subjective': 'ðŸ¤” Subjective Claim', 'value_judgment': 'âš–ï¸ Value Judgment', 'prediction': 'ðŸ”® Prediction' };
                badgeContainer.innerHTML = '<span class="claim-type-badge ' + claimType.toLowerCase() + '">' + (labels[claimType.toLowerCase()] || claimType) + '</span>';
            } else {
                badgeContainer.innerHTML = '';
            }
            var confBadge = document.getElementById('confidenceBadge');
            if (confidence) {
                confBadge.textContent = confidence + ' Confidence';
                confBadge.className = 'confidence-badge ' + confidence.toLowerCase();
                confBadge.style.display = 'inline-flex';
            } else {
                confBadge.style.display = 'none';
            }
        }


        // Character counter function
        function updateCharCounter() {
            var question = document.getElementById('question');
            var counter = document.getElementById('charCounter');
            var warning = document.getElementById('charWarning');
            var len = question.value.length;
            
            counter.textContent = len + ' / 280 characters';
            
            // Update color based on length
            counter.classList.remove('green', 'yellow', 'red');
            if (len <= 200) {
                counter.classList.add('green');
            } else if (len <= 280) {
                counter.classList.add('yellow');
            } else {
                counter.classList.add('red');
            }
            
            // Show warning if over 400 characters
            if (len > 400) {
                warning.classList.add('visible');
            } else {
                warning.classList.remove('visible');
            }
        }

        // Amplify cooldown timer function
        function startAmplifyCooldown() {
            var amplifyBtn = document.getElementById('amplifyBtn');
            var adjudicateBtn = document.getElementById('adjudicateBtn');
            var notice = document.getElementById('amplifyCooldown');
            var timerDisplay = document.getElementById('cooldownTimer');
            
            amplifyCooldownSeconds = 60;
            amplifyBtn.disabled = true;
            adjudicateBtn.disabled = true;
            notice.classList.add('visible');
            timerDisplay.textContent = amplifyCooldownSeconds;
            
            // Clear any existing timer
            if (amplifyCooldownTimer) {
                clearInterval(amplifyCooldownTimer);
            }
            
            amplifyCooldownTimer = setInterval(function() {
                amplifyCooldownSeconds--;
                timerDisplay.textContent = amplifyCooldownSeconds;
                
                if (amplifyCooldownSeconds <= 0) {
                    clearInterval(amplifyCooldownTimer);
                    amplifyBtn.disabled = false;
                    adjudicateBtn.disabled = false;
                    notice.classList.remove('visible');
                }
            }, 1000);
        }

        function setMode(mode) {
            currentMode = mode;
            var questionTab = document.getElementById('questionModeTab');
            var articleTab = document.getElementById('articleModeTab');
            var urlField = document.getElementById('urlField');
            var modeHint = document.getElementById('modeHint');
            var questionLabel = document.getElementById('questionLabel');
            var articleTextarea = document.getElementById('articleText');
            var questionInput = document.getElementById('question');
            
            if (mode === 'article') {
                questionTab.classList.remove('active');
                articleTab.classList.add('active');
                urlField.classList.add('visible');
                modeHint.innerHTML = 'Paste the article text below. Providing the URL helps VERITAS verify source credibility.';
                questionLabel.textContent = 'What aspect to assess? (Optional)';
                questionInput.placeholder = 'e.g., Is this article accurate? What claims need verification?';
                articleTextarea.placeholder = 'Paste the full article text here for assessment...';
            } else {
                articleTab.classList.remove('active');
                questionTab.classList.add('active');
                urlField.classList.remove('visible');
                modeHint.innerHTML = 'Enter a claim or question and VERITAS will search for evidence and provide an assessment.';
                questionLabel.textContent = 'Question or Claim to Assess';
                questionInput.placeholder = 'Enter ONE specific claim to assess (e.g., \'Climate change is primarily caused by human activity\')';
                articleTextarea.placeholder = 'Paste article text here for analysis, or leave blank to assess just the question above...';
            }
        }

        function clearForm() {
            document.getElementById('question').value = '';
            document.getElementById('articleText').value = '';
            document.getElementById('articleUrl').value = '';
            document.getElementById('trackBQuestion').value = '';
            document.getElementById('errorBox').classList.remove('visible');
            document.getElementById('results').classList.remove('visible');
            document.getElementById('amplifiedResults').classList.remove('visible');
            document.getElementById('secondAssessmentResults').classList.remove('visible');
            document.getElementById('scoreComparison').classList.remove('visible');
            document.getElementById('postAssessmentOptions').style.display = 'none';
            // Reset character counters
            updateCharCounter();
            updateTrackBCharCounter();
            document.getElementById('amplifiedResults').classList.remove('visible');
            lastAssessment = null;
            resetTrackASections();
            // Reset Track B state
            selectedCriteria = [];
            customCriteriaList = [];
            renderCriteriaList();
            updateCriteriaCount();
            // Hide Track B results
            var trackBResults = document.getElementById('trackBResultsContainer');
            if (trackBResults) trackBResults.classList.remove('visible');
            // Show score bars again
            document.querySelector('.score-bars-container').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateScoreDisplay(realityScore, integrityScore) {
            // Update hero score
            var heroScoreEl = document.getElementById('heroScore');
            var heroQuestionEl = document.getElementById('heroQuestion');
            
            if (realityScore !== null && realityScore !== undefined) {
                var scoreNum = parseFloat(realityScore);
                heroScoreEl.textContent = (scoreNum >= 0 ? '+' : '') + scoreNum;
                
                // Color based on score
                heroScoreEl.classList.remove('positive', 'negative', 'neutral');
                if (scoreNum >= 3) {
                    heroScoreEl.classList.add('positive');
                } else if (scoreNum <= -3) {
                    heroScoreEl.classList.add('negative');
                } else {
                    heroScoreEl.classList.add('neutral');
                }
                
                // Update reality score bar
                document.getElementById('realityScoreDisplay').textContent = (scoreNum >= 0 ? '+' : '') + scoreNum;
                var realityPercent = ((scoreNum + 10) / 20) * 100;
                document.getElementById('realityMarker').style.left = realityPercent + '%';
            } else {
                heroScoreEl.textContent = '-';
                document.getElementById('realityScoreDisplay').textContent = '-';
            }
            
            // Update question display
            heroQuestionEl.textContent = currentQuestion || 'Assessment Complete';
            
            // Update integrity score bar
            if (integrityScore !== null && integrityScore !== undefined) {
                var integrityNum = parseFloat(integrityScore);
                document.getElementById('integrityScoreDisplay').textContent = (integrityNum >= 0 ? '+' : '') + integrityNum.toFixed(2);
                var integrityPercent = ((integrityNum + 1) / 2) * 100;
                document.getElementById('integrityMarker').style.left = integrityPercent + '%';
            } else {
                document.getElementById('integrityScoreDisplay').textContent = '-';
            }
        }

        function toggleSection(sectionId) {
            var content = document.getElementById(sectionId + 'Content');
            var toggle = document.getElementById(sectionId + 'Toggle');
            if (content && toggle) {
                content.classList.toggle('expanded');
                toggle.textContent = content.classList.contains('expanded') ? 'âˆ’' : '+';
            }
        }

        function formatAssessment(text) {
            var sections = [
                { pattern: /\*\*CLAIM TYPE CLASSIFICATION\*\*/i, hidden: true },
                { pattern: /\*\*TEMPORAL VERIFICATION COMPLETED\*\*/i, hidden: true },
                { pattern: /\*\*CLAIM BEING TESTED\*\*/i, hidden: true },
                { pattern: /\*\*(?:THE )?UNDERLYING (?:TRUTH|REALITY)\*\*/i, title: 'ðŸ” The Underlying Reality', hdr: 'header-truth', id: 'truth', order: 1 },
                { pattern: /\*\*EVIDENCE ANALYSIS\*\*/i, title: 'ðŸ“‹ Evidence Analysis', hdr: 'header-evidence', id: 'evidence', order: 2 },
                { pattern: /\*\*TRUTH DISTORTION (?:ANALYSIS|PATTERNS)\*\*/i, title: 'âš ï¸ Truth Distortion Analysis', hdr: 'header-distortion', id: 'distortion', order: 3 },
                { pattern: /\*\*REALITY SCORE BREAKDOWN\*\*/i, title: 'ðŸ“Š Reality Score Breakdown', hdr: 'header-reality-breakdown', id: 'realityBrkdn', order: 4 },
                { pattern: /\*\*INTEGRITY SCORE BREAKDOWN\*\*/i, title: 'ðŸ“Š Integrity Score Breakdown', hdr: 'header-integrity-breakdown', id: 'integrityBrkdn', order: 5 },
                { pattern: /\*\*EXAMINING THE QUESTION'?S? FRAMEWORK\*\*/i, title: 'ðŸ”¬ Examining the Framework', hdr: 'header-framework', id: 'framework', order: 6 },
                { pattern: /\*\*INTEGRITY ANALYSIS\*\*/i, title: 'ðŸ”’ Integrity Analysis', hdr: 'header-integrity-breakdown', id: 'integrityAnal', order: 7 },
                { pattern: /\*\*(?:THE )?CENTRAL CLAIMS?\*\*/i, title: 'ðŸ“Œ Central Claims', hdr: 'header-claim', id: 'claims', order: 8 },
                { pattern: /\*\*VERITAS ASSESSMENT\*\*/i, title: 'ðŸ“Š VERITAS Assessment', noCollapse: true, order: 9 },
                { pattern: /\*\*WHAT WE CAN BE CONFIDENT ABOUT\*\*/i, title: 'âœ… What We Can Be Confident About', hdr: 'header-confident', id: 'confident', order: 10 },
                { pattern: /\*\*WHAT REMAINS (?:GENUINELY )?UNCERTAIN\*\*/i, title: 'â“ What Remains Uncertain', hdr: 'header-uncertain', id: 'uncertain', order: 11 },
                { pattern: /\*\*BOTTOM LINE\*\*/i, title: 'ðŸŽ¯ Bottom Line', hdr: 'header-bottom', id: 'bottom', order: 12 },
                { pattern: /\*\*LESSONS FOR INFORMATION ASSESSMENT\*\*/i, title: 'ðŸ“š Lessons', hdr: 'header-lessons', id: 'lessons', order: 13 },
                { pattern: /\*\*KEY SOURCES(?: REFERENCED)?\*\*/i, title: 'ðŸ“– Key Sources', hdr: 'header-sources', id: 'sources', order: 14 },
                { pattern: /\*\*METHODOLOGY NOTES?\*\*/i, title: 'âš™ï¸ Methodology Notes', hdr: 'header-methodology', id: 'methodology', order: 15 }
            ];
            
            var cleanText = text;
            var jsonMarker = cleanText.indexOf('<!-- VERITAS_STRUCTURED_OUTPUT -->');
            if (jsonMarker > 0) { cleanText = cleanText.substring(0, jsonMarker); }
            cleanText = cleanText.replace(/\*\*FINAL REALITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*FINAL INTEGRITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*REALITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*EPISTEMOLOGICAL INTEGRITY SCORE:[^*]*\*\*/gi, '');
            cleanText = cleanText.replace(/\*\*INTEGRITY SCORE:[^*]*\*\*/gi, '');
            
            var parsed = [], i, j, section, match, startIdx, endIdx, nextMatch, content;
            for (i = 0; i < sections.length; i++) {
                section = sections[i];
                match = cleanText.match(section.pattern);
                if (match) {
                    startIdx = match.index + match[0].length;
                    endIdx = cleanText.length;
                    for (j = 0; j < sections.length; j++) {
                        if (j === i) continue;
                        nextMatch = cleanText.substring(startIdx).match(sections[j].pattern);
                        if (nextMatch && (startIdx + nextMatch.index) < endIdx) {
                            endIdx = startIdx + nextMatch.index;
                        }
                    }
                    content = cleanText.substring(startIdx, endIdx).trim();
                    if (content && !section.hidden) {
                        content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                        content = formatListsAndParagraphs(content);
                        parsed.push({ sec: section, content: content });
                    }
                }
            }
            parsed.sort(function(a, b) { return (a.sec.order || 99) - (b.sec.order || 99); });
            
            var html = '';
            for (i = 0; i < parsed.length; i++) {
                var s = parsed[i].sec, c = parsed[i].content;
                if (s.noCollapse) {
                    html += '<div class="veritas-assessment-section"><h3>' + s.title + '</h3>' + c + '</div>';
                } else {
                    html += '<div class="collapsible-section"><div class="section-header-box ' + s.hdr + '" onclick="toggleSection(\'' + s.id + '\')"><h3>' + s.title + '</h3><button class="section-toggle-btn" id="' + s.id + 'Toggle">+</button></div><div class="section-content" id="' + s.id + 'Content">' + c + '</div></div>';
                }
            }
            if (!html) { html = '<div class="assessment-section"><p>' + text.replace(/\n/g, '<br>') + '</p></div>'; }
            return html;
        }

        function formatListsAndParagraphs(content) {
            // Split by double newlines for paragraphs
            var lines = content.split('\n');
            var result = '';
            var inList = false;
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                // Check if it's a bullet point
                if (line.match(/^[â€¢\-\*]\s+/)) {
                    if (!inList) {
                        result += '<ul>';
                        inList = true;
                    }
                    result += '<li>' + line.replace(/^[â€¢\-\*]\s+/, '') + '</li>';
                } else {
                    if (inList) {
                        result += '</ul>';
                        inList = false;
                    }
                    result += '<p>' + line + '</p>';
                }
            }
            
            if (inList) {
                result += '</ul>';
            }
            
            return result;
        }

        function formatAmplified(text) {
            var sections = [
                { pattern: /\*\*AMPLIFI(?:CATION|ED(?: ANALYSIS)?) SUMMARY\*\*/i, title: 'ðŸ” Amplified Analysis Summary', icon: '' },
                { pattern: /\*\*MISSING PERSPECTIVES\*\*/i, title: 'ðŸŒ Missing Perspectives', icon: '' },
                { pattern: /\*\*ALTERNATIVE FRAMINGS?\*\*/i, title: 'ðŸ”„ Alternative Framings', icon: '' },
                { pattern: /\*\*WHAT WOULD CHANGE (?:THE|THIS) ASSESSMENT\??\*\*/i, title: 'ðŸ”® What Would Change This Assessment?', icon: '' },
                { pattern: /\*\*UNCERTAINTY CATEGORIZATION\*\*/i, title: 'ðŸ“Š Uncertainty Categorization', icon: '' },
                { pattern: /\*\*EPISTEMIC HUMILITY CHECK\*\*/i, title: 'ðŸ¤” Epistemic Humility Check', icon: '' },
                { pattern: /\*\*BOTTOM LINE\*\*/i, title: 'âœ… Bottom Line', icon: '' }
            ];
            
            var html = '';
            var i, j, section, match, startIdx, endIdx, nextMatch, content;
            
            for (i = 0; i < sections.length; i++) {
                section = sections[i];
                match = text.match(section.pattern);
                if (match) {
                    startIdx = match.index + match[0].length;
                    endIdx = text.length;
                    
                    for (j = i + 1; j < sections.length; j++) {
                        nextMatch = text.substring(startIdx).match(sections[j].pattern);
                        if (nextMatch) {
                            endIdx = startIdx + nextMatch.index;
                            break;
                        }
                    }
                    
                    content = text.substring(startIdx, endIdx).trim();
                    content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    content = formatListsAndParagraphs(content);
                    
                    if (content) {
                        html += '<div class="amplified-section">';
                        html += '<h4>' + section.title + '</h4>';
                        html += content;
                        html += '</div>';
                    }
                }
            }
            
            if (!html) {
                html = '<div class="amplified-section"><p>' + text.replace(/\n/g, '<br>') + '</p></div>';
            }
            
            return html;
        }

        function runAssessment() {
            var question = document.getElementById('question').value.trim();
            var articleText = document.getElementById('articleText').value.trim();
            var articleUrl = document.getElementById('articleUrl').value.trim();
            var userApiKey = document.getElementById('apiKey').value.trim();
            var btn = document.getElementById('assessBtn');
            var errorBox = document.getElementById('errorBox');
            var results = document.getElementById('results');

            // Validation based on mode
            if (currentMode === 'article') {
                if (!articleText && !articleUrl) {
                    errorBox.textContent = 'Please provide an article URL or paste the article text.';
                    errorBox.classList.add('visible');
                    return;
                }
            } else {
                if (!question && !articleText) {
                    errorBox.textContent = 'Please enter a question or paste article text.';
                    errorBox.classList.add('visible');
                    return;
                }
            }

            // Build article context
            var finalArticleText = '';
            if (articleUrl && articleText) {
                finalArticleText = 'SOURCE URL: ' + articleUrl + '\n\nARTICLE TEXT:\n' + articleText;
            } else if (articleUrl) {
                finalArticleText = 'SOURCE URL: ' + articleUrl + '\n\nPlease fetch and analyze this article using web search.';
            } else if (articleText) {
                finalArticleText = articleText;
            }
            
            // Default question for URL-only article assessment
            var finalQuestion = question;
            if (currentMode === 'article' && !question && articleUrl) {
                finalQuestion = 'Assess the accuracy and epistemological integrity of this article.';
            }

            // Store question for display
            currentQuestion = finalQuestion || 'Article Assessment';

            errorBox.classList.remove('visible');
            btn.disabled = true;
            btn.textContent = 'Analyzing with web search...';
            results.classList.remove('visible');
            document.getElementById('amplifiedResults').classList.remove('visible');
            document.getElementById('secondAssessmentResults').classList.remove('visible');
            document.getElementById('scoreComparison').classList.remove('visible');
            document.getElementById('postAssessmentOptions').style.display = 'none';

            var requestBody = {
                question: finalQuestion,
                articleText: finalArticleText,
                userApiKey: userApiKey,
                track: 'a'
            };

            fetch('/api/assess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                var contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server error - please try again. If assessing a URL, try pasting the article text instead.');
                }
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Assessment failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                updateScoreDisplay(data.realityScore, data.integrityScore);
                updateClaimTypeAndConfidence(
                    data.claimType || (data.structured && data.structured.claimType),
                    data.confidence || (data.structured && data.structured.confidence)
                );
                if (data.structured) {
                    renderStructuredOutput(data.structured);
                }
                document.getElementById('formattedAssessment').innerHTML = formatAssessment(data.assessment);
                results.classList.add('visible');

                lastAssessment = {
                    question: finalQuestion || 'Article Assessment',
                    articleText: finalArticleText || '',
                    assessment: data.assessment,
                    realityScore: data.realityScore,
                    integrityScore: data.integrityScore
                };

                // Show the post-assessment options panel
                document.getElementById('postAssessmentOptions').style.display = 'block';
                
                // Reset comparison panel for new assessment
                document.getElementById('scoreComparison').classList.remove('visible');
                document.getElementById('secondAssessmentResults').classList.remove('visible');
                document.getElementById('amplifiedResults').classList.remove('visible');

                // Start the cooldown timer for both buttons
                startAmplifyCooldown();

                results.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                errorBox.textContent = 'Error: ' + err.message;
                errorBox.classList.add('visible');
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Assess with VERITAS';
            });
        }

        function truncateForAmplify(assessment) {
            if (assessment.length > 4000) {
                return assessment.substring(0, 4000) + '\n\n[...Assessment truncated for amplification analysis...]';
            }
            return assessment;
        }

        function runAmplify() {
            if (!lastAssessment) return;

            var btn = document.getElementById('amplifyBtn');
            var userApiKey = document.getElementById('apiKey').value.trim();

            btn.disabled = true;
            btn.textContent = 'ðŸ” Amplifying...';

            var truncatedAssessment = truncateForAmplify(lastAssessment.assessment);

            var requestBody = {
                question: lastAssessment.question,
                assessment: truncatedAssessment,
                userApiKey: userApiKey,
                track: 'a'
            };

            fetch('/api/amplify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Amplification failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                document.getElementById('formattedAmplified').innerHTML = formatAmplified(data.amplified);
                document.getElementById('amplifiedResults').classList.add('visible');
                // Keep options panel visible but update button states
                var amplifyBtn = document.getElementById('amplifyBtn');
                amplifyBtn.textContent = 'âœ“ Amplified';
                amplifyBtn.disabled = true;
                document.getElementById('amplifiedResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                alert('Amplification error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'ðŸ” Amplify â€” Epistemic Deep Dive';
            });
        }

        function runTrackBAmplify() {
            if (!lastAssessment) return;

            var btn = document.getElementById('trackBAmplifyBtn');
            var userApiKey = document.getElementById('apiKey').value.trim();

            btn.disabled = true;
            btn.textContent = 'ðŸ” Filling in the gaps...';

            var truncatedAssessment = truncateForAmplify(lastAssessment.assessment);

            var requestBody = {
                question: lastAssessment.question,
                assessment: truncatedAssessment,
                userApiKey: userApiKey,
                track: 'b'
            };

            fetch('/api/amplify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Amplification failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                document.getElementById('formattedAmplified').innerHTML = formatAmplified(data.amplified);
                document.getElementById('amplifiedResults').classList.add('visible');
                btn.textContent = 'âœ“ Holes Plugged';
                btn.disabled = true;
                document.getElementById('amplifiedResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                alert('Amplification error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'ðŸ” Plug the Holes â€” Fill in What\'s Missing';
            });
        }

        function runVerify() {
            if (!lastAssessment) return;

            var btn = document.getElementById('adjudicateBtn');
            var userApiKey = document.getElementById('apiKey').value.trim();

            btn.disabled = true;
            btn.textContent = 'âœ“ Verifying...';

            var requestBody = {
                question: lastAssessment.question,
                articleText: lastAssessment.articleText || '',
                userApiKey: userApiKey,
                track: 'a'
            };

            fetch('/api/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'Verification failed');
                    }
                    return data;
                });
            })
            .then(function(data) {
                // Store verify results for potential adjudication
                lastAssessment.verifyAssessment = data.assessment;
                lastAssessment.verifyRealityScore = data.realityScore;
                lastAssessment.verifyIntegrityScore = data.integrityScore;
                
                // Display the verification assessment
                document.getElementById('formattedSecondAssessment').innerHTML = formatAssessment(data.assessment);
                document.getElementById('secondAssessmentResults').classList.add('visible');
                
                // Update the score comparison table
                updateScoreComparison(
                    lastAssessment.realityScore,
                    lastAssessment.integrityScore,
                    data.realityScore,
                    data.integrityScore
                );
                
                // Check variance and trigger adjudication if needed
                var realityVariance = Math.abs((lastAssessment.realityScore || 0) - (data.realityScore || 0));
                var adjudicateBtn = document.getElementById('adjudicateBtn');
                
                if (realityVariance > 2.0) {
                    // High variance - auto-trigger adjudication
                    adjudicateBtn.textContent = 'âš–ï¸ High Variance - Adjudicating...';
                    triggerAdjudication();
                } else {
                    // Low variance - no adjudication needed
                    adjudicateBtn.textContent = 'âœ“ Verified (Variance: Â±' + realityVariance.toFixed(1) + ')';
                    adjudicateBtn.disabled = true;
                }
                
                // Scroll to comparison first, then assessment
                document.getElementById('scoreComparison').scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(function(err) {
                alert('Verification error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'âœ“ Verify â€” Independent Confirmation';
            });
        }

        function updateScoreComparison(primaryReality, primaryIntegrity, secondaryReality, secondaryIntegrity) {
            // Populate the comparison table
            document.getElementById('primaryReality').textContent = formatScoreDisplay(primaryReality);
            document.getElementById('primaryIntegrity').textContent = formatIntegrityDisplay(primaryIntegrity);
            document.getElementById('secondaryReality').textContent = formatScoreDisplay(secondaryReality);
            document.getElementById('secondaryIntegrity').textContent = formatIntegrityDisplay(secondaryIntegrity);
            
            // Calculate differences
            var realityDiff = Math.abs((primaryReality || 0) - (secondaryReality || 0));
            var integrityDiff = Math.abs((primaryIntegrity || 0) - (secondaryIntegrity || 0));
            
            // Format difference displays
            var diffRealityEl = document.getElementById('diffReality');
            var diffIntegrityEl = document.getElementById('diffIntegrity');
            
            diffRealityEl.textContent = 'Â±' + realityDiff.toFixed(1);
            diffIntegrityEl.textContent = 'Â±' + integrityDiff.toFixed(2);
            
            // Color code based on discrepancy
            diffRealityEl.className = realityDiff <= 1 ? 'score-match' : (realityDiff <= 2 ? 'score-minor-diff' : 'score-major-diff');
            diffIntegrityEl.className = integrityDiff <= 0.15 ? 'score-match' : (integrityDiff <= 0.3 ? 'score-minor-diff' : 'score-major-diff');
            
            // Show appropriate alert
            var consensusNote = document.getElementById('consensusNote');
            var discrepancyAlert = document.getElementById('discrepancyAlert');
            
            // Thresholds: Reality > 2 points or Integrity > 0.3 is significant
            var hasSignificantDiscrepancy = realityDiff > 2 || integrityDiff > 0.3;
            var hasMinorDiscrepancy = realityDiff > 1 || integrityDiff > 0.15;
            
            if (hasSignificantDiscrepancy) {
                consensusNote.classList.remove('visible');
                discrepancyAlert.classList.add('visible');
                document.getElementById('discrepancyText').textContent = 
                    'Significant discrepancy detected (Reality: Â±' + realityDiff.toFixed(1) + 
                    ', Integrity: Â±' + integrityDiff.toFixed(2) + ') â€” review both assessments carefully.';
            } else if (hasMinorDiscrepancy) {
                discrepancyAlert.classList.remove('visible');
                consensusNote.classList.add('visible');
                document.getElementById('consensusText').textContent = 
                    'Minor variance between assessors â€” both evaluations are reasonably aligned.';
            } else {
                discrepancyAlert.classList.remove('visible');
                consensusNote.classList.add('visible');
                document.getElementById('consensusText').textContent = 
                    'Strong consensus between assessors â€” high confidence in this evaluation.';
            }
            
            // Show the comparison panel
            document.getElementById('scoreComparison').classList.add('visible');
        }

        function triggerAdjudication() {
            if (!lastAssessment || !lastAssessment.verifyAssessment) return;
            
            var btn = document.getElementById('adjudicateBtn');
            btn.disabled = true;
            
            var userApiKey = document.getElementById('apiKey').value.trim();
            
            fetch('/api/adjudicate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: lastAssessment.question,
                    initialAssessment: lastAssessment.assessment,
                    verifyAssessment: lastAssessment.verifyAssessment,
                    initialScore: lastAssessment.realityScore,
                    verifyScore: lastAssessment.verifyRealityScore,
                    userApiKey: userApiKey
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    if (!response.ok) throw new Error(data.error || 'Adjudication failed');
                    return data;
                });
            })
            .then(function(data) {
                // Display adjudication result
                var resultHtml = '<div class="adjudication-result" style="margin-top:16px;padding:16px;background:#1e1b4b;border-radius:8px;border-left:4px solid #7c3aed;">';
                resultHtml += '<h4 style="color:#a78bfa;margin-bottom:8px;">âš–ï¸ Adjudication Result</h4>';
                resultHtml += '<p><strong>Winner:</strong> Assessment ' + data.winner + ' (' + (data.winner === 'A' ? 'Initial' : 'Verify') + ')</p>';
                resultHtml += '<p><strong>Confidence:</strong> ' + (data.confidence * 100).toFixed(0) + '%</p>';
                resultHtml += '<p style="font-size:1.2em;color:#22c55e;"><strong>Final Score:</strong> ' + (data.finalScore >= 0 ? '+' : '') + data.finalScore.toFixed(1) + '</p>';
                resultHtml += '<details style="margin-top:12px;"><summary style="cursor:pointer;color:#a78bfa;">View Full Analysis</summary>';
                resultHtml += '<div style="margin-top:8px;padding:12px;background:#0f0d1a;border-radius:4px;font-size:0.9em;white-space:pre-wrap;">' + data.adjudication + '</div></details>';
                resultHtml += '</div>';
                
                var comparisonPanel = document.getElementById('scoreComparison');
                var existing = comparisonPanel.querySelector('.adjudication-result');
                if (existing) existing.remove();
                comparisonPanel.insertAdjacentHTML('beforeend', resultHtml);
                
                btn.textContent = 'âš–ï¸ Final: ' + (data.finalScore >= 0 ? '+' : '') + data.finalScore.toFixed(1);
                lastAssessment.finalScore = data.finalScore;
            })
            .catch(function(err) {
                alert('Adjudication error: ' + err.message);
                btn.textContent = 'âš–ï¸ Adjudication Failed';
            });
        }

        function formatScoreDisplay(score) {
            if (score === null || score === undefined) return 'â€”';
            var num = parseFloat(score);
            return (num >= 0 ? '+' : '') + num.toFixed(0);
        }

        function formatIntegrityDisplay(score) {
            if (score === null || score === undefined) return 'â€”';
            var num = parseFloat(score);
            return (num >= 0 ? '+' : '') + num.toFixed(2);
        }
    </script>
</body>
</html>